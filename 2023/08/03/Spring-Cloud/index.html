<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
  <title>
    
    Spring Cloud 丨
    

    Lism Blog
  </title>

  
  <link rel="shortcut icon" href="/icon.svg">
  

  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <link id="theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.css">
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  

  <!-- 字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

  
<link rel="stylesheet" href="/css/root.css">

  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/post.css">

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="/Lism Blog" type="application/atom+xml">
</head>

<body>
  <header class="header">
  <section class="header-container">
    <a class="logo" href="/">/Lism Blog</a>
    <ul class="nav">
      
      <li><a href="/archives">archives</a></li>
      
      <li><a href="/about">about</a></li>
      
    </ul>
  </section>
</header>
  <main class="main">
    <article class="post">
  
  <div class="post-title">Spring Cloud</div>
  <div class="post-meta">
    <div class="date">2023 八月 3日</div>
    <div class="tags">
      
      <div class="tag-item">Spring Cloud</div>
      
    </div>
  </div>
  

  <main class="post-content"><h1 id="微服务框架-spring-cloud"><a class="markdownIt-Anchor" href="#微服务框架-spring-cloud"></a> 微服务框架 Spring Cloud</h1>
<p>[toc]</p>
<hr />
<h2 id="spring-cloud入门"><a class="markdownIt-Anchor" href="#spring-cloud入门"></a> Spring Cloud入门</h2>
<h3 id="微服务与微服务架构"><a class="markdownIt-Anchor" href="#微服务与微服务架构"></a> 微服务与微服务架构</h3>
<p>做服务架构是一种新型的系统架构。其设计思路是。<strong>将单体架构系统拆分为多个可以相互调用、配合的独立运行的小程序</strong>。这每个小程序对整体系统所提供的功能就称为一个微服务。</p>
<p>由于每个微服务都是独立运行的，所以每个教服务都独自占用一个进程。<strong>微服务间采用轻量级的HTTP RESTful协议通信，每个微服务程序不受编程语言的限制，整个系统关心的是微服务程序所提供的具体服务，并不关心其具体的实现</strong>。每个微服务可以有自己独立的数据库。即可以操作自己的独立数据库，也可以操作整体系统的数据库。</p>
<h3 id="spring-cloud简介"><a class="markdownIt-Anchor" href="#spring-cloud简介"></a> Spring Cloud简介</h3>
<h4 id="百度百科"><a class="markdownIt-Anchor" href="#百度百科"></a> 百度百科</h4>
<p><strong>Spring Cloud是一系列框架的有序集合</strong>。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署。Spring Cloud并没有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者提供了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>
<p>简单来说，Spring Cloud就是将现有的分布式开发技术整合到了Spring Boot中。形象地讲，Spring Boot就是火锅，而现有的分布式开发技术就是要吃的“涮菜、测肉&quot;，而学习SpringCloud就是在“吃火锅”</p>
<p>截止到目前，Spring Cloud已经集成了至少24种技术框架。在Spring Cloud官网首页可以一目了然这24种技术。<br />
<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">Spring Cloud 官 网</a></p>
<h4 id="官网介绍"><a class="markdownIt-Anchor" href="#官网介绍"></a> 官网介绍</h4>
<p><a target="_blank" rel="noopener" href="http://spring.io">打开spring官网：http://spring.io</a></p>
<p>翻译：构建分布式系统不需要复杂和容易出错，Spring Cloud为最常见的分布式系统模式提供了一种简单且易于接受的编程模型，帮助开发人员构建有弹性的、可靠的、协调的应用程序，Spring Cloud构建于Spring Boot之上，使得开发者很容易入手并快速应用于生产中。</p>
<p>该简介下方即为官方提供的Spring Cloud项目的体系结构图，从中可以看到，其为N多种技术的综合体</p>
<blockquote>
<p>IoT ：Internet of Things 物联网</p>
</blockquote>
<h4 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4>
<p>Spring Cloud是什么？</p>
<p><strong>Spring Cloud是微服务系统架构的一站式解决方案</strong></p>
<p>Spring Cloud和Spring Boot是什么关系呢？</p>
<p><strong>Spring Boot为Spring Cloud提供了代码实现环境</strong>，使用Spring Boot将其他组件有机融合到了Spring Cloud的体系架构中了，所以说，springCloud是基于Spring Boot的，微服务系统架构的一站式解决方案</p>
<h4 id="spring-cloud-在线资源"><a class="markdownIt-Anchor" href="#spring-cloud-在线资源"></a> Spring Cloud 在线资源</h4>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">Spring Cloud 官网：https://spring.io/projects/spring-cloud</a></p>
<p><a target="_blank" rel="noopener" href="https://springcloud.cc/">Spring Cloud中文网：https://springcloud.cc/</a></p>
<p><a target="_blank" rel="noopener" href="http://springcloud.cn/">Spring Cloud中国社区：http:/springcloud.cn/</a></p>
<h3 id="spring-clouddubbo"><a class="markdownIt-Anchor" href="#spring-clouddubbo"></a> Spring Cloud/Dubbo</h3>
<p><strong>Spring Cloud与Dubbo均为微服务框架</strong>，开发团队在进行技术选型时，总会将它们进行对比，考虑应该选择哪一个。其实这两个概架没有可比性</p>
<p>与Spring Cloud相比，Dubbo 的架构完整度不够，其本身仅仅提供了服务注册中心与服务治理两个模块，而Sping Cloud到目前为止已经提供了服务注册中心服务治理等24个模块，并且现在还在增加中。，</p>
<p>Dubbo本身仅仅提供了服务注册中心与服务治理两个模块，并不是说其它功能其就不能够实现，Dubbo的设计是开放型的，其可通过整合第三方的相关功能框架。但也正因为如此，搭建出的Dubbo架构可能就存在兼容性问题。而Spring Cloud不存在这个问题，其出品的每一个模块都是经过严格测试的，几乎不存在兼容性问题。所以，若将Spring Cloud比作品牌电脑的话，Dubbo就是一台自己动手组装的电脑。</p>
<p>与Spring Cloud相比，Dubbo的社区活跃度太低。对于团队来说，社区活跃度高低将会影响整个项目的维护成本。当社区活跃度很高时，在一般性的工程中遇到的问题，在社区中基本都可找到相应的解决方案</p>
<p><strong>Dubbo服务间的通讯采用的是RPC</strong>,而<strong>Spring Cloud则采用的是HTTP的REST</strong>. RPC对于业务接口具有强依赖性，必须要保证通讯双方具有相同的业务接口。而这个保证就必须要通过严格的业务接口版本管理来实现。这种强依赖在大型的微服务项目中将会成为一个很大的问题。相比RPC, REST更为轻量化。服务提供者和调用者间的依赖仅仅是一纸契约，一段文本，不存在代码级别的强依赖。</p>
<p>对于国内开发团队来说，可能选择Dubbo的一个很重要原因就是官方文档。Dubbo 提供了高质量的中文版官方文档，而Spring Cloud的文档都是英文版的。Spring Cloud文档在体量上比Dubbo多很多，文档内容更多的是偏向模块整合，对于每个模块更深入的方法，两要用户查看其更为详细文档。对于中小型开发团队来说，对于英文文档的阅读成本，是必须要考虑的。</p>
<h3 id="服务提供者消费者项目"><a class="markdownIt-Anchor" href="#服务提供者消费者项目"></a> 服务提供者/消费者项目</h3>
<p>该项目为后续学习Spring Cloud的基础项目，也是前提准备</p>
<h4 id="服务提供者项目"><a class="markdownIt-Anchor" href="#服务提供者项目"></a> 服务提供者项目</h4>
<p><strong>项目创建</strong></p>
<p>创建一个基础的Spring Boot项目：</p>
<p>项目名：</p>
<p>导入项目基础jar包：</p>
<p>项目目录如下：</p>
<hr />
<p><strong>pom依赖</strong></p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="comment">&lt;!--修改MySQL驱动版本--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>主配置文件application.properties</strong></p>
<pre><code class="highlight properties"><span class="comment">#指定端口号</span>
<span class="attr">server.port</span>=<span class="string">8081</span>
<span class="comment">#更改访问上下文路径/访问路径 localhost:8088/leeBoot/...</span>
<span class="comment">#server.servlet.context-path=/leeBoot</span>
<span class="comment"></span>
<span class="comment">#开启启动时自动建表</span>
<span class="attr">spring.jpa.generate-ddl</span>=<span class="string">true</span>
<span class="comment">#是否在控制台显示sql语句</span>
<span class="attr">spring.jpa.show-sql</span>=<span class="string">true</span>
<span class="comment">#设置应用启动时不重新建表</span>
<span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">none</span>
<span class="comment"></span>
<span class="comment">#配置数据源</span>
<span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span>
<span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span>
<span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/leetest?characterEncoding=UTF-8</span>
<span class="attr">spring.datasource.username</span>=<span class="string">root</span>
<span class="attr">spring.datasource.password</span>=<span class="string">123456</span>
<span class="comment"></span>
<span class="comment"></span>
<span class="comment"></span>
<span class="comment">#配置日志输出格式</span>
<span class="attr">logging.pattern.console</span>=<span class="string">%level %msg%n</span>
<span class="comment">#设置spring boot启动时的日志级别</span>
<span class="attr">logging.level.root</span>=<span class="string">info</span>
<span class="comment">#hibernate运行日志级别   org.gibernate表示类名</span>
<span class="attr">logging.level.org.hibernate</span>=<span class="string">info</span>
<span class="comment">#在show-sql为true时显示sql中的动态参数值</span>
<span class="attr">logging.level.org.hibernate.type.descriptor.sql.BasicBinder</span>=<span class="string">trace</span>
<span class="comment">#在show-sql为true时显示查询结果</span>
<span class="attr">logging.level.org.hibernate.type.descriptor.sql.BasicExtractor</span>=<span class="string">trace</span>
<span class="comment">#控制自己代码运行时显示的日志级别</span>
<span class="attr">logging.level.com.lee</span>=<span class="string">debug</span></code></pre>
<hr />
<p><strong>编写bean</strong></p>
<ul>
<li>因为我们使用Spring Data JPA，所以我们不需要建表，框架会帮我们建好数据库表</li>
<li>@<code>Entity</code>：数据库名与实体类名一一映射</li>
<li>@<code>JsonIgnoreProperties</code>：
<ul>
<li>忽略掉hebernate的延迟加载，防止要json序列化值时其值为空</li>
<li>用来在json序列化时将java bean中的一些属性忽略掉</li>
</ul>
</li>
<li>@<code>Id</code>：用在成员变量，表示该字段时主键</li>
<li>@<code>GeneratedValue</code>：用在成员变量，可设置字段自增</li>
<li>@<code>Column</code>：用在成员变量，表明对应的数据库字段名</li>
</ul>
<blockquote>
<p>controller处理器方法的返回值是作为json数据响应给浏览器的，这个数据转换工作是由SpringMVC的HttpMessageConverter接口完成的，确切的说，是由该接口的一个实现类Jackson完成的</p>
</blockquote>
<blockquote>
<p>但默认情况下，Hibernate对所有对象的查询采用了延迟加载策略，由Hibernate延迟初始化器hibernateLazyInitializer完成，其首先会将javasist，动态代理对象先传递给了Jackson，在访问详情时在做查询，但Jackson在拿到代理对象后马上就要将其转换为json而不等待，所以我们要使用@JsonIgnoreProperties注解忽略掉hebernate的延迟加载</p>
</blockquote>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider.bean;

<span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnoreProperties;
<span class="keyword">import</span> lombok.Data;

<span class="keyword">import</span> javax.persistence.*;

<span class="comment">/**</span>
<span class="comment"> * 这里先不使用mybatis,使用Spring Data JPA</span>
<span class="comment"> * jpa可以自动根据该类在数据库中生成表</span>
<span class="comment"> */</span>

<span class="meta">@Data</span>   <span class="comment">//lombok用来生成getter和setter方法的</span>
<span class="comment">//用来将该实体类与数据库表进行一对一映射,不写name表示和数据库表depart一对一映射</span>
<span class="meta">@Entity(name = &quot;t_depart&quot;)</span>
<span class="comment">//忽略掉hebernate的延迟加载</span>
<span class="comment">//还可以用来在json序列化时将java bean中的一些属性忽略掉</span>
<span class="meta">@JsonIgnoreProperties(&#123;&quot;hibernateLazyInitializer&quot;,&quot;handler&quot;,&quot;fieldHandler&quot;&#125;)</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Depart</span> &#123;
    <span class="comment">//表示主键</span>
    <span class="meta">@Id</span>
    <span class="comment">//设置字段自增</span>
    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="keyword">private</span> Integer id;
    <span class="comment">//表明对应的数据库字段名</span>
    <span class="meta">@Column(name = &quot;name&quot;)</span>
    <span class="keyword">private</span> String name;
    <span class="meta">@Column(name = &quot;dbase&quot;)</span>
    <span class="keyword">private</span> String dbase;
&#125;
</code></pre>
<hr />
<p><strong>编写dao层</strong></p>
<p>对于spring Data来说，dao层默认名字为Repository</p>
<ul>
<li>JpaRepository继承自PagingAndSortingRepository接口，JpaRepository基于JPA的Repository接口，极大减少了JPA作为数据访问的代码，JpaRepository是实现Spring Data JPA技术访问数据库的关键接口</li>
<li>当我们需要定义自己的Repository的时候，我们可以继承JpaRepository，从而获得Spring为我们预先定义的多种基本数据操作方法</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider.repository;


<span class="keyword">import</span> com.lee.provider.bean.Depart;
<span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="comment">/**</span>
<span class="comment"> * 这个类相当于mybatis时的dao</span>
<span class="comment"> *</span>
<span class="comment"> * 第一个泛型:当前Repository的操作对象类型</span>
<span class="comment"> * 第二个泛型:当前Repository的操作对象的id类型</span>
<span class="comment"> */</span>
<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DepartRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Depart, Integer&gt; &#123;

&#125;</code></pre>
<hr />
<p><strong>编写service层</strong></p>
<p>service层接口</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider.service;

<span class="keyword">import</span> com.lee.provider.bean.Depart;

<span class="keyword">import</span> java.util.List;

<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DepartService</span> &#123;

    <span class="type">boolean</span> <span class="title function_">saveDepart</span><span class="params">(Depart depart)</span>;
    <span class="type">boolean</span> <span class="title function_">removeDepartById</span><span class="params">(<span class="type">int</span> id)</span>;
    <span class="type">boolean</span> <span class="title function_">modifyDepart</span><span class="params">(Depart depart)</span>;
    Depart <span class="title function_">getDepartById</span><span class="params">(<span class="type">int</span> id)</span>;
    List&lt;Depart&gt; <span class="title function_">listAllDeparts</span><span class="params">()</span>;
&#125;
</code></pre>
<p>service层实现：</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider.service;

<span class="keyword">import</span> com.lee.provider.bean.Depart;
<span class="keyword">import</span> com.lee.provider.repository.DepartRepository;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.stereotype.Service;

<span class="keyword">import</span> java.util.List;

<span class="meta">@Service</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DepartService</span> &#123;
    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> DepartRepository repository;

    <span class="meta">@Override</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveDepart</span><span class="params">(Depart depart)</span> &#123;
        <span class="comment">//如果这个depart的id在数据库中存在，就执行update</span>
        <span class="comment">//如果这个depart的id字数据库中不存在，就执行insert</span>
        <span class="comment">//返回值就是你插入的对象</span>
        <span class="type">Depart</span> <span class="variable">result</span> <span class="operator">=</span> repository.save(depart);
        <span class="keyword">if</span> (result!=<span class="literal">null</span>) &#123;
            <span class="keyword">return</span> <span class="literal">true</span>;
        &#125;
        <span class="keyword">return</span> <span class="literal">false</span>;
    &#125;

    <span class="meta">@Override</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">removeDepartById</span><span class="params">(<span class="type">int</span> id)</span> &#123;
        <span class="comment">//判断数据库是否有id</span>
        <span class="keyword">if</span> (repository.existsById(id)) &#123;
            <span class="comment">//如果数据库有id，就会给删除掉，如果没有该id,执行就会抛异常</span>
            repository.deleteById(id);
            <span class="keyword">return</span> <span class="literal">true</span>;
        &#125;
        <span class="keyword">return</span> <span class="literal">false</span>;
    &#125;

    <span class="meta">@Override</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">modifyDepart</span><span class="params">(Depart depart)</span> &#123;
        <span class="comment">//如果这个depart的id在数据库中存在，就执行update</span>
        <span class="comment">//如果这个depart的id字数据库中不存在，就执行insert</span>
        <span class="comment">//返回值就是你插入的对象</span>
        <span class="type">Depart</span> <span class="variable">result</span> <span class="operator">=</span> repository.save(depart);
        <span class="keyword">if</span> (result!=<span class="literal">null</span>) &#123;
            <span class="keyword">return</span> <span class="literal">true</span>;
        &#125;
        <span class="keyword">return</span> <span class="literal">false</span>;
    &#125;

    <span class="meta">@Override</span>
    <span class="keyword">public</span> Depart <span class="title function_">getDepartById</span><span class="params">(<span class="type">int</span> id)</span> &#123;
        <span class="comment">//判断数据库是否有id</span>
        <span class="keyword">if</span> (repository.existsById(id)) &#123;
            <span class="comment">//如果id不存在，会抛出异常</span>
            <span class="keyword">return</span> repository.getOne(id);
        &#125;
        <span class="comment">//尽量避免给返回null</span>
        <span class="type">Depart</span> <span class="variable">depart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Depart</span>();
        depart.setName(<span class="string">&quot;no this depart&quot;</span>);
        <span class="keyword">return</span> depart;
    &#125;

    <span class="meta">@Override</span>
    <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listAllDeparts</span><span class="params">()</span> &#123;
        <span class="keyword">return</span> repository.findAll();
    &#125;
&#125;
</code></pre>
<hr />
<p><strong>编写Controller</strong></p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider.Controller;

<span class="keyword">import</span> com.lee.provider.bean.Depart;
<span class="keyword">import</span> com.lee.provider.service.DepartService;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="keyword">import</span> java.util.List;

<span class="meta">@RequestMapping(&quot;/provider/depart&quot;)</span>
<span class="meta">@RestController</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartController</span> &#123;
    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> DepartService service;

    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="comment">//@RequestBody表示传过来的数据时json数据</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveHandle</span><span class="params">(<span class="meta">@RequestBody</span> Depart depart)</span> &#123;
        <span class="keyword">return</span> service.saveDepart(depart);
    &#125;

    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="comment">//@PathVariable 表示获取url中的&#123;id&#125;的值</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteHandle</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;
        <span class="keyword">return</span> service.removeDepartById(id);
    &#125;

    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateHandle</span><span class="params">(<span class="meta">@RequestBody</span> Depart depart)</span>&#123;
        <span class="keyword">return</span> service.modifyDepart(depart);
    &#125;

    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    <span class="keyword">public</span> Depart <span class="title function_">GetHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span>&#123;
        <span class="keyword">return</span> service.getDepartById(id);
    &#125;

    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listHandle</span><span class="params">()</span> &#123;
        <span class="keyword">return</span> service.listAllDeparts();
    &#125;
&#125;
</code></pre>
<h4 id="消费者项目"><a class="markdownIt-Anchor" href="#消费者项目"></a> 消费者项目</h4>
<p><strong>项目创建</strong></p>
<p>创建一个基础的Spring Boot项目：</p>
<p>项目名：</p>
<p>添加相关jar包：</p>
<p>项目目录如下：</p>
<hr />
<p><strong>pom依赖</strong></p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>
<span class="tag">&lt;/<span class="name">project</span>&gt;</span></code></pre>
<p><strong>spring boot主配置文件</strong></p>
<pre><code class="highlight properties"><span class="comment">#指定端口号</span>
<span class="attr">server.port</span>=<span class="string">8080</span></code></pre>
<hr />
<p><strong>编写bean</strong></p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.bean;

<span class="keyword">import</span> lombok.Data;

<span class="meta">@Data</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Depart</span> &#123;
    <span class="keyword">private</span> Integer id;
    <span class="keyword">private</span> String name;
    <span class="keyword">private</span> String dbase;
&#125;</code></pre>
<hr />
<p><strong>编写Configuration文件</strong></p>
<ul>
<li>传统情况下在java代码里访问restful服务，一般使用Apache的HttpClient。不过此种方法使用起来太过繁琐。spring提供了一种简单便捷的模板类来进行操作，这就是<strong>RestTemplate</strong></li>
<li>调用远程服务时就必须使用HTTP客户端,主要有四种：JDK原生的URLConnection、Apache的Http Client、Netty的异步HTTP Client, Spring的RestTemplate。</li>
<li>restTemplate是spring提供的可以提供访问rest服务的客户端工具类，提供多种快捷的访问远程的方法，大大提高了客户端的编程效率。解放了原先HttpClient的复杂提交，java中调用RESTful服务很典型的是使用HttpClient，对于常用的REST操作，这些方法属于低等级的操作。使用HttpClient我们需要自己封装Post请求，再根据响应的状态码判断从响应中获取header和body，有时候还需要自己做json转换</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.codeconfig;

<span class="keyword">import</span> org.springframework.context.annotation.Bean;
<span class="keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="meta">@Configuration</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartCodeConfig</span> &#123;
    <span class="meta">@Bean</span>
    <span class="comment">//bean的名称就相当于方法名</span>
    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();
    &#125;
&#125;</code></pre>
<hr />
<p><strong>编写Controller</strong></p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.Controller;

<span class="keyword">import</span> com.lee.consumer.bean.Depart;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="keyword">import</span> java.util.List;

<span class="meta">@RestController</span>
<span class="meta">@RequestMapping(&quot;/consumer/depart&quot;)</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartController</span> &#123;

    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> RestTemplate restTemplate;

    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="comment">//@RequestBody表示传过来的数据时json数据</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/provider/depart/save&quot;</span>;
        <span class="comment">//url/传入参数/调用方法返回值</span>
        <span class="keyword">return</span> restTemplate.postForObject(url, depart, Boolean.class);
    &#125;

    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="comment">//@PathVariable 表示获取url中的&#123;id&#125;的值</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteHandle</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;
        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/provider/depart/del/&quot;</span>+id;
        restTemplate.delete(url);
    &#125;


    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/provider/depart/update&quot;</span>;
        restTemplate.put(url,depart);
    &#125;

    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    <span class="keyword">public</span> Depart <span class="title function_">GetHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span> &#123;
        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/provider/depart/get/&quot;</span>+id;
        <span class="keyword">return</span> restTemplate.getForObject(url,Depart.class);
    &#125;

    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listHandle</span><span class="params">()</span> &#123;
        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8081/provider/depart/list&quot;</span>;
        <span class="keyword">return</span> restTemplate.getForObject(url, List.class);
    &#125;
&#125;</code></pre>
<h2 id="相关注解详解"><a class="markdownIt-Anchor" href="#相关注解详解"></a> 相关注解详解</h2>
<h3 id="json序列化相关注解"><a class="markdownIt-Anchor" href="#json序列化相关注解"></a> JSON序列化相关注解</h3>
<p><strong>问题由来：</strong><br />
springboot项目中定义了很多类，我们在rest返回中直接返回或者在返回对象中使用这些类，spring已经使用jackson自动帮我们完成这些的to json。但是有时候自动转的json内容太多，或者格式不符合我们的期望，因此需要调整类的to json过程，或者说希望自定义类的json过程。</p>
<p><strong>问题解决</strong></p>
<p>使用@JsonIgnoreProperties、@JsonIgnore、@JsonForma。</p>
<ul>
<li>
<p>@<strong>JsonIgnore</strong>注解用来忽略某些字段，可以用在变量或者Getter方法上，用在Setter方法时，和变量效果一样。这个注解一般用在我们要忽略的字段上。</p>
</li>
<li>
<p>@<strong>JsonIgnoreProperties</strong>(ignoreUnknown = true)，将这个注解写在类上之后，就会忽略类中不存在的字段。这个注解还可以指定要忽略的字段，例如@JsonIgnoreProperties({ “password”, “secretKey” })</p>
</li>
<li>
<p>@<strong>JsonFormat</strong>可以帮我们完成格式转换。例如对于Date类型字段，如果不适用JsonFormat默认在rest返回的是long，如果我们使用@JsonFormat(timezone = “GMT+8”, pattern = “yyyy-MM-dd HH:mm:ss”)，就返回&quot;2018-11-16 22:58:15&quot;</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://fasterxml.github.io/jackson-annotations/javadoc/2.6/com/fasterxml/jackson/annotation/JsonIgnoreProperties.html">具体可以参考官方文档</a></p>
<blockquote>
<p>@JsonIgnoreProperties与@JsonIgnore的主要区别在于， @JsonIgnoreProperties是类级别的， 而@JsonIgnore是变量和方法级别的。</p>
</blockquote>
<p><strong>代码示例</strong><br />
代码简要说明， User类的fullName 和comment字段会被@JsonIgnoreProperties注解忽略。address字段会被@JsonIgnore注解忽略。regDate会按照@JsonFormat(timezone = “GMT+8”, pattern = “yyyy-MM-dd HH:mm:ss”)进行格式转</p>
<pre><code class="highlight java"><span class="meta">@Data</span>
<span class="meta">@JsonIgnoreProperties(value = &#123;&quot;fullName&quot;, &quot;comment&quot;&#125;)</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;
    <span class="keyword">private</span> String id;
    <span class="keyword">private</span> String name;
    <span class="keyword">private</span> String fullName;
    <span class="keyword">private</span> String comment;
    <span class="keyword">private</span> String mail;

    <span class="meta">@JsonIgnore</span>
    <span class="keyword">private</span> String address;

    <span class="meta">@JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span>
    <span class="keyword">private</span> Date regDate;

    <span class="keyword">private</span> Date reg2Date;
&#125;</code></pre>
<p>Controller代码</p>
<pre><code class="highlight java"><span class="meta">@ApiOperation(value = &quot;按用户id删除&quot;, notes=&quot;private&quot;)</span>
<span class="meta">@ApiImplicitParams(&#123;</span>
<span class="meta">        @ApiImplicitParam(name = &quot;userId&quot;, defaultValue = &quot;2&quot;, value = &quot;userID&quot;, required = true, dataType = &quot;string&quot;, paramType = &quot;path&quot;),</span>
<span class="meta">&#125;)</span>
<span class="meta">@DeleteMapping(value = &quot;/users/&#123;userId&#125;&quot;, produces = &quot;application/json;charset=UTF-8&quot;)</span>
<span class="keyword">public</span> User <span class="title function_">delUser</span><span class="params">(<span class="meta">@PathVariable</span> String userId)</span> &#123;
    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User)userSvc.deleteById(userId);
    log.info(<span class="string">&quot;rest del user=&#123;&#125; by id=&#123;&#125;&quot;</span>, user, userId);
    <span class="keyword">return</span> user;
&#125;</code></pre>
<p>可以看到返回的对象是User，然后comment、fullName、address属性被忽略了，regDate的格式进行转换</p>
<h3 id="generatedvalue"><a class="markdownIt-Anchor" href="#generatedvalue"></a> @GeneratedValue</h3>
<p>@GeneratedValue注解存在的意义主要就是<strong>为一个实体生成一个唯一标识的主键</strong>、@GeneratedValue提供了主键的生成策略</p>
<p>@GeneratedValue注解有两个属性,分别是strategy和generator,</p>
<ul>
<li>generator属性：
<ul>
<li>generator属性的值是一个字符串,默认为&quot;&quot;,其声明了主键生成器的名称(对应于同名的主键生成器@SequenceGenerator和@TableGenerator)</li>
</ul>
</li>
</ul>
<hr />
<ul>
<li><strong>strategy属性</strong>：提供四种值:
<ul>
<li>AUTO：主键由程序控制, 是默认选项 ,不设置就是这个</li>
<li>IDENTITY ：主键由数据库生成, 采用数据库自增长, Oracle不支持这种方式</li>
<li>SEQUENCE： 通过数据库的序列产生主键, MYSQL  不支持</li>
<li>Table ：提供特定的数据库产生主键, 该方式更有利于数据库的移植</li>
</ul>
</li>
</ul>
<blockquote>
<p>默认SpringBoot的@GeneratedValue 是不需要加参数的,但是如果数据库控制主键自增(auto_increment), 不加参数就会报错</p>
</blockquote>
<h3 id="spring-data-jpa之jparepository"><a class="markdownIt-Anchor" href="#spring-data-jpa之jparepository"></a> Spring Data JPA之JpaRepository</h3>
<p><strong>使用Spring Data JPA CrudRepository 和JpaRepository 的好处</strong>：</p>
<ul>
<li>继承这些接口，可以使Spring找到自定义的数据库操作接口，并生成代理类，后续可以注入到Spring容器中；</li>
<li>可以不写相关的sql操作，由代理类生成</li>
</ul>
<p><strong>JpaRepository接口的官方定义如下</strong>：</p>
<pre><code class="highlight plaintext">public interface JpaRepository&lt;T, ID&gt; extends PagingAndSortingRepository&lt;T, ID&gt;, QueryByExampleExecutor&lt;T&gt;</code></pre>
<p>可以看出JpaRepository继承了接口PagingAndSortingRepository和QueryByExampleExecutor。而，PagingAndSortingRepository又继承CrudRepository。</p>
<p>也就是说， CrudRepository 提供基本的增删改查；PagingAndSortingRepository 提供分页和排序方法；JpaRepository 提供JPA需要的方法</p>
<p><strong>当我们需要定义自己的Repository的时候，我们可以继承JpaRepository</strong>，从而获得Spring为我们预先定义的多种基本数据操作方法。</p>
<pre><code class="highlight plaintext">public interface UserRepository extends JpaRepository&lt;User, Integer&gt; &#123;
&#125;</code></pre>
<p><strong>各函数说明</strong></p>
<pre><code class="highlight java"> <span class="comment">/**</span>
<span class="comment">    * 保存一个实体。</span>
<span class="comment">    */</span>
   &lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; S <span class="title function_">save</span><span class="params">(S entity)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 保存提供的所有实体。</span>
<span class="comment">    */</span>
   &lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; Iterable&lt;S&gt; <span class="title function_">saveAll</span><span class="params">(Iterable&lt;S&gt; entities)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 根据id查询对应的实体。</span>
<span class="comment">    */</span>
   Optional&lt;T&gt; <span class="title function_">findById</span><span class="params">(ID id)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 根据id查询对应的实体是否存在。</span>
<span class="comment">    */</span>
   <span class="type">boolean</span> <span class="title function_">existsById</span><span class="params">(ID id)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 查询所有的实体。</span>
<span class="comment">    */</span>
   Iterable&lt;T&gt; <span class="title function_">findAll</span><span class="params">()</span>;

   <span class="comment">/**</span>
<span class="comment">    * 根据给定的id集合查询所有对应的实体，返回实体集合。</span>
<span class="comment">    */</span>
   Iterable&lt;T&gt; <span class="title function_">findAllById</span><span class="params">(Iterable&lt;ID&gt; ids)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 统计现存实体的个数。</span>
<span class="comment">    */</span>
   <span class="type">long</span> <span class="title function_">count</span><span class="params">()</span>;

   <span class="comment">/**</span>
<span class="comment">    * 根据id删除对应的实体。</span>
<span class="comment">    */</span>
   <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(ID id)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 删除给定的实体。</span>
<span class="comment">    */</span>
   <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(T entity)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 删除给定的实体集合。</span>
<span class="comment">    */</span>
   <span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">(Iterable&lt;? extends T&gt; entities)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 删除所有的实体。</span>
<span class="comment">    */</span>
   <span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">()</span>;

  <span class="comment">/**</span>
<span class="comment">    * 返回所有的实体，根据Sort参数提供的规则排序。</span>
<span class="comment">    */</span>
   Iterable&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Sort sort)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 返回一页实体，根据Pageable参数提供的规则进行过滤。</span>
<span class="comment">    */</span>
   Page&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Pageable pageable)</span>;
<span class="comment">/**</span>
<span class="comment">    * 将所有未决的更改刷新到数据库。</span>
<span class="comment">    */</span>
   <span class="keyword">void</span> <span class="title function_">flush</span><span class="params">()</span>;

   <span class="comment">/**</span>
<span class="comment">    * 保存一个实体并立即将更改刷新到数据库。</span>
<span class="comment">    */</span>
   &lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; S <span class="title function_">saveAndFlush</span><span class="params">(S entity)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 在一个批次中删除给定的实体集合，这意味着将产生一条单独的Query。</span>
<span class="comment">    */</span>
   <span class="keyword">void</span> <span class="title function_">deleteInBatch</span><span class="params">(Iterable&lt;T&gt; entities)</span>;

   <span class="comment">/**</span>
<span class="comment">    * 在一个批次中删除所有的实体。</span>
<span class="comment">    */</span>
   <span class="keyword">void</span> <span class="title function_">deleteAllInBatch</span><span class="params">()</span>;

   <span class="comment">/**</span>
<span class="comment">    * 根据给定的id标识符，返回对应实体的引用。</span>
<span class="comment">    */</span>
   T <span class="title function_">getOne</span><span class="params">(ID id)</span>;
</code></pre>
<h3 id="hystrixcommand"><a class="markdownIt-Anchor" href="#hystrixcommand"></a> @HystrixCommand</h3>
<pre><code class="highlight java"><span class="keyword">package</span> com.example.demo.service;

<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.stereotype.Service;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;
<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;

<span class="meta">@Service</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerService</span> &#123;

    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> RestTemplate restTemplate;

    <span class="meta">@HystrixCommand(commandKey = &quot;testCommand&quot;, groupKey = &quot;testGroup&quot;, threadPoolKey = &quot;testThreadKey&quot;,</span>
<span class="meta">            fallbackMethod = &quot;hiConsumerFallBack&quot;, ignoreExceptions = &#123;NullPointerException.class&#125;,</span>
<span class="meta">            threadPoolProperties = &#123;</span>
<span class="meta">                    @HystrixProperty(name = &quot;coreSize&quot;, value = &quot;30&quot;),</span>
<span class="meta">                    @HystrixProperty(name = &quot;maxQueueSize&quot;, value = &quot;101&quot;),</span>
<span class="meta">                    @HystrixProperty(name = &quot;keepAliveTimeMinutes&quot;, value = &quot;2&quot;),</span>
<span class="meta">                    @HystrixProperty(name = &quot;queueSizeRejectionThreshold&quot;, value = &quot;15&quot;),</span>
<span class="meta">                    @HystrixProperty(name = &quot;metrics.rollingStats.numBuckets&quot;, value = &quot;12&quot;),</span>
<span class="meta">                    @HystrixProperty(name = &quot;metrics.rollingStats.timeInMilliseconds&quot;, value = &quot;1440&quot;)</span>
<span class="meta">            &#125;</span>
<span class="meta">            )</span>
    <span class="keyword">public</span> String <span class="title function_">hiConsumer</span><span class="params">(String id)</span> &#123;
        
        <span class="comment">//SERVICE_HI是服务端的spring.application.name，并且大写，hi为服务端提供的接口</span>
        <span class="keyword">return</span> restTemplate.getForEntity(<span class="string">&quot;http://SERVICE_HI/hi&quot;</span>, String.class).getBody();
    &#125;
    
    <span class="keyword">public</span> String <span class="title function_">hiConsumerFallBack</span><span class="params">(String id, Throwable e)</span> &#123;
        <span class="keyword">return</span> <span class="string">&quot;This is a error&quot;</span>;
    &#125;

&#125;</code></pre>
<p>让我们来逐个介绍下@HystrixCommand注解的各个参数：</p>
<p>1：<strong>commandKey</strong>：配置全局唯一标识服务的名称，比如，库存系统有一个获取库存服务，那么就可以为这个服务起一个名字来唯一识别该服务，如果不配置，则默认是@HystrixCommand注解修饰的函数的函数名。</p>
<p>2：<strong>groupKey</strong>：一个比较重要的注解，配置全局唯一标识服务分组的名称，比如，库存系统就是一个服务分组。通过设置分组，Hystrix会根据组来组织和统计命令的告、仪表盘等信息。Hystrix命令默认的线程划分也是根据命令组来实现。默认情况下，Hystrix会让相同组名的命令使用同一个线程池，所以我们需要在创建Hystrix命令时为其指定命令组来实现默认的线程池划分。此外，Hystrix还提供了通过设置threadPoolKey来对线程池进行设置。建议最好设置该参数，使用threadPoolKey来控制线程池组。</p>
<p>3：<strong>threadPoolKey</strong>：对线程池进行设定，细粒度的配置，相当于对单个服务的线程池信息进行设置，也可多个服务设置同一个threadPoolKey构成线程组。</p>
<p>4：<strong>fallbackMethod</strong>：@HystrixCommand注解修饰的函数的回调函数，@HystrixCommand修饰的函数必须和这个回调函数定义在同一个类中，因为定义在了同一个类中，所以fackback method可以是public/private均可。</p>
<p>5：<strong>commandProperties</strong>：配置该命令的一些参数，如executionIsolationStrategy配置执行隔离策略，默认是使用线程隔离，此处我们配置为THREAD，即线程池隔离。参见：com.netflix.hystrix.HystrixCommandProperties中各个参数的定义。</p>
<p>6：<strong>threadPoolProperties</strong>：线程池相关参数设置，具体可以设置哪些参数请见：com.netflix.hystrix.HystrixThreadPoolProperties</p>
<p>7：<strong>ignoreExceptions</strong>：调用服务时，除了HystrixBadRequestException之外，其他@HystrixCommand修饰的函数抛出的异常均会被Hystrix认为命令执行失败而触发服务降级的处理逻辑（调用fallbackMethod指定的回调函数），所以当需要在命令执行中抛出不触发降级的异常时来使用它，通过这个参数指定，哪些异常抛出时不触发降级（不去调用fallbackMethod），而是将异常向上抛出。</p>
<p>8：<strong>observableExecutionMode</strong>：定义hystrix observable command的模式；</p>
<p>9：<strong>raiseHystrixExceptions</strong>：任何不可忽略的异常都包含在HystrixRuntimeException中；</p>
<p>10：<strong>defaultFallback</strong>：默认的回调函数，该函数的函数体不能有入参，返回值类型与@HystrixCommand修饰的函数体的返回值一致。如果指定了fallbackMethod，则fallbackMethod优先级更高</p>
<h3 id="cacheresult注解"><a class="markdownIt-Anchor" href="#cacheresult注解"></a> @CacheResult注解</h3>
<table>
<thead>
<tr>
<th>注解</th>
<th>描述</th>
<th>属性</th>
</tr>
</thead>
<tbody>
<tr>
<td>@CacheResult</td>
<td>该注解用来标记请求命令返回的结果应该被缓存，它必须与@HystrixCommand注解结合使用</td>
<td>cacheKeyMethod</td>
</tr>
<tr>
<td>@CacheRemove</td>
<td>该注解用来让请求命令的缓存失效，失效的缓存根据定义Key决定</td>
<td>commandKey,cacheKeyMethod</td>
</tr>
<tr>
<td>@CacheKey</td>
<td>该注解用来在请求命令的参数上标记，使其作为缓存的Key值，如果没有标注则会使用所有参数。如果同事还是使用了@CacheResult和@CacheRemove注解的cacheKeyMethod方法指定缓存Key的生成，那么该注解将不会起作用</td>
<td>value</td>
</tr>
</tbody>
</table>
<p>该注解标记结果需要被缓存，并且<strong>这个注解需要结合@HystrixCommand注解一起使用</strong>。该注解有一个参数cacheKeyMethod，用来指定获取cacheKey的方法名。Hystrix会根据获取到的cacheKey值来区分是否是重复请求，如果他们的cacheKey相同，那么该依赖服务只会在第一个请求到达时被真实的调用一次，另外一个请求则是直接从请求缓存中根据这个cacheKey来获取到的结果。所以开启请求缓存可以让我们实现的Hystrix命令具备下面几项好处：</p>
<ul>
<li>减少重复的请求数，降低依赖服务的并发度；</li>
<li>在同一个用户请求的上下文，想同依赖服务的返回数据始终保持一致。</li>
<li>请求缓存在run()和contruct()执行之前生效，所以可以有效减少不必要的线程开销；</li>
</ul>
<p>使用@CacheResult开启缓存代码示例：</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.example.demo;
 
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.stereotype.Service;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;
 
<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.cache.annotation.CacheResult;
<span class="keyword">import</span> com.example.demo.entity.User;
<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
 
<span class="meta">@Service</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheResultDemo</span> &#123;
 
    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> RestTemplate restTemplate;
 
    <span class="meta">@CacheResult(cacheKeyMethod = &quot;getUserId&quot;)</span>
    <span class="meta">@HystrixCommand(fallbackMethod = &quot;hiConsumerFallBack&quot;)</span>
    <span class="keyword">public</span> User <span class="title function_">hiConsumer</span><span class="params">(String id)</span> &#123;
        
        <span class="comment">//SERVICE_HI是服务端的spring.application.name，并且大写，hi为服务端提供的接口</span>
        <span class="keyword">return</span> restTemplate.getForEntity(<span class="string">&quot;http://SERVICE_HI/hi&quot;</span>, User.class).getBody();
    &#125;
    
    <span class="keyword">public</span> String <span class="title function_">hiConsumerFallBack</span><span class="params">(String id, Throwable e)</span> &#123;
        <span class="keyword">return</span> <span class="string">&quot;This is a error&quot;</span>;
    &#125;
    
    <span class="keyword">public</span> String <span class="title function_">getUserId</span><span class="params">(String id)</span> &#123;
        <span class="keyword">return</span> id;
    &#125;
 
&#125;</code></pre>
<p>使用CacheKey开启缓存代码示例：</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.example.demo;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.stereotype.Service;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;
importcom.netflix.hystrix.contrib.javanica.cache.annotation.CacheKey;
<span class="keyword">import</span> com.example.demo.entity.User;
importcom.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
<span class="meta">@Service</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheKeyDemo</span> &#123;
      <span class="meta">@Autowired</span>
      <span class="keyword">private</span> RestTemplate restTemplate;
      <span class="meta">@HystrixCommand(fallbackMethod = &quot;hiConsumerFallBack&quot;)</span>
      <span class="keyword">public</span> User <span class="title function_">hiConsumer</span><span class="params">(<span class="meta">@CacheKey(&quot;id&quot;)</span> String id)</span> &#123;
            
            <span class="comment">//SERVICE_HI是服务端的spring.application.name，并且大写，hi为服务端提供的接口</span>
            <span class="keyword">return</span> restTemplate.getForEntity(<span class="string">&quot;http://SERVICE_HI/hi&quot;</span>, User.class).getBody();
      &#125;
      
      <span class="keyword">public</span> String <span class="title function_">hiConsumerFallBack</span><span class="params">(String id, Throwable e)</span> &#123;
            <span class="keyword">return</span> <span class="string">&quot;This is a error&quot;</span>;
      &#125;
&#125;</code></pre>
<p>其中@CacheKey除了可以指定方法参数为缓存key之外，还可以指定对象中的属性作为缓存Key，如下：</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.example.demo;
 
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.stereotype.Service;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;
 
<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.cache.annotation.CacheKey;
<span class="keyword">import</span> com.example.demo.entity.User;
<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
 
<span class="meta">@Service</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheKeyDemo2</span> &#123;
 
    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> RestTemplate restTemplate;
 
    <span class="meta">@HystrixCommand(fallbackMethod = &quot;hiConsumerFallBack&quot;)</span>
    <span class="keyword">public</span> User <span class="title function_">hiConsumer</span><span class="params">(<span class="meta">@CacheKey(&quot;id&quot;)</span> User user)</span> &#123;
        
        <span class="comment">//SERVICE_HI是服务端的spring.application.name，并且大写，hi为服务端提供的接口</span>
        <span class="keyword">return</span> restTemplate.getForEntity(<span class="string">&quot;http://SERVICE_HI/hi&quot;</span>, User.class, user.getId()).getBody();
    &#125;
    
    <span class="keyword">public</span> String <span class="title function_">hiConsumerFallBack</span><span class="params">(String id, Throwable e)</span> &#123;
        <span class="keyword">return</span> <span class="string">&quot;This is a error&quot;</span>;
    &#125;
 
&#125;</code></pre>
<p>清理失效缓存功能：</p>
<p>使用请求缓存时，如果只是读操作，那么不需要考虑缓存中的内容是否正确的问题，但是如果请求命令中还有更新数据的写操作，那么缓存中的数据就需要我们在进行写操作时进行及时处理，以防止读操作的请求命令获取到了失效的数据。</p>
<p>通过@CacheRemove注解来实现失效缓存清理功能：</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.example.demo;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.stereotype.Service;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;
importcom.netflix.hystrix.contrib.javanica.cache.annotation.CacheKey;
importcom.netflix.hystrix.contrib.javanica.cache.annotation.CacheRemove;
<span class="keyword">import</span> com.example.demo.entity.User;
importcom.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
<span class="meta">@Service</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheRemoveDemo</span> &#123;
      <span class="meta">@Autowired</span>
      <span class="keyword">private</span> RestTemplate restTemplate;
      <span class="meta">@CacheRemove(commandKey = &quot;getUserId&quot;)</span>
      <span class="meta">@HystrixCommand(fallbackMethod = &quot;hiConsumerFallBack&quot;)</span>
      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="meta">@CacheKey(&quot;id&quot;)</span> User user)</span> &#123;
            
            <span class="comment">//SERVICE_HI是服务端的spring.application.name，并且大写，hi为服务端提供的接口</span>
            restTemplate.postForObject(<span class="string">&quot;http://SERVICE_HI/hi&quot;</span>, user, User.class);
            <span class="keyword">return</span>;
      &#125;
      
      <span class="keyword">public</span> String <span class="title function_">hiConsumerFallBack</span><span class="params">(String id, Throwable e)</span> &#123;
            <span class="keyword">return</span> <span class="string">&quot;This is a error&quot;</span>;
      &#125;
      
      <span class="keyword">public</span> String <span class="title function_">getUserId</span><span class="params">(String id)</span> &#123;
            <span class="keyword">return</span> id;
      &#125;
&#125;</code></pre>
<h2 id="微服务中心eureka"><a class="markdownIt-Anchor" href="#微服务中心eureka"></a> 微服务中心Eureka</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/Netflix/eureka">官方网址：https://github.com/Netflix/eureka</a></p>
<h3 id="eureka引入"><a class="markdownIt-Anchor" href="#eureka引入"></a> Eureka引入</h3>
<p>前面的例子存在一个问题:消费者直接连接的提供者。这样做的问题是，若提供者出现宕机，或消费者存在高并发情况，那么消费者就会出现问题。所以，我们就需要一个服务注册中心，就像之前的zokeeper一样。提供者对于消费者来说是透明的，不固定的。。</p>
<p>所有提供者将自己提供服务的名称及自己主机详情(IP、端口、版本等)写入到另一台主机中，这台主机称为服务注册中心。所有消费者需要哪种服务只需向注册中心提交服务名称，注册中心就会根据该服务的所有提供者当前的运行情况(繁忙度、健康状态等)，将一个合适的提供者信息发送给消费者，由消费者访问提供者提供的服务。</p>
<p>可以充当Spring Cloud服务注册中心的服务器很多，如Zookeeper、Eureka、Consul<br />
Template and Nginx.但目前在实际生产环境中使用最多，Spring Cloud支持最好的就是Eurekae</p>
<h4 id="eureka概述"><a class="markdownIt-Anchor" href="#eureka概述"></a> Eureka概述</h4>
<p>Eureka，古希腊词语，意思是“我找到了!我发现了!”</p>
<p>Eureka是Netfix(美国一家视频网络平台公司)开发的服务发现框架，本身是一个基于REST的服务，主要用于定位运行在AwS (Amazon Web Serices, |亚马逊网络服务，一种类似于阿里云的云计算服务)域中的中间层服务，以达到负载均衡和中间层服务故障转移的目的。Springcloud将它集成在其子项目spring doud-.etfix中，实现SpringCloud 的<strong>服务发现功能</strong>。</p>
<p>Eureka包含两个组件:<strong>Eureka Server</strong>和<strong>Eureka Client</strong></p>
<p><strong>Eureka Server</strong>提供<strong>服务注册功能</strong>，提供者节点启动后，会在Eureka Server中进行注册,这样Eureka Server的服务注册表中将会存储所有可用服务节点的信息。然后各提供者将会向Eureka Server发送<strong>心跳</strong>，以告知Eureka Server自己的健康状况，默认<strong>周期为30秒</strong>。如果在多个心跳周期内(默认3个周期90秒没有接收到某个提供者节点的心跳，Eureka Server会认为其已无法提供服务，会将该提供者节点从服务注册表中移除。Eureka Server之间通过复制的方式完成数据的同步。工</p>
<p><strong>Eureka Client</strong>是一个java客户端，用于<strong>简化消费者与Eureka Server的交证</strong>。同时，EurekaClient还内置有<strong>负载7种均衡器</strong>，为消费者从Fureka Server的服务注册表中选择合适的提供者.</p>
<p>Eureka提供了<strong>客户端缓存机制</strong>（因为他把注册表信息都下载到了自己本地），即使所有的Eureka Server都挂掉，客户端依然可以利用缓存中的信息为消费者提供服务发现功能。不过，此时不再接受服务注册，因为EurekaServer已经全部挂掉了。这就是<strong>AP原则（可用性）</strong>（zookeeper遵循的CP原则（一致性））的体现。</p>
<p>综上，Eureka通过心跳检查、客户端缓存等机制，确保了系统的高可用性、灵活性和可伸缩性。</p>
<h4 id="eureka体系结构"><a class="markdownIt-Anchor" href="#eureka体系结构"></a> Eureka体系结构</h4>
<h3 id="创建eureka服务中心"><a class="markdownIt-Anchor" href="#创建eureka服务中心"></a> 创建Eureka服务中心</h3>
<p>只需三步即可创建一个Eureka服务中心</p>
<ul>
<li>导入EurekaServer依赖</li>
<li>在主配置文件中配置EurekaServer</li>
<li>在启动类中添加注解@<strong>EnableEurekaServer</strong> 开启EurekaServer</li>
</ul>
<h4 id="创建工程"><a class="markdownIt-Anchor" href="#创建工程"></a> 创建工程</h4>
<p>创建一个spring boot工程：</p>
<p>工程名：</p>
<p>导入Eureka依赖：</p>
<h4 id="pom依赖主配置文件"><a class="markdownIt-Anchor" href="#pom依赖主配置文件"></a> pom依赖/主配置文件</h4>
<p>pom依赖：</p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eurekaserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>eurekaserver<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>

    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>如果使用的是jdk 8以上的高版本，还需导入下列依赖</strong></p>
<blockquote>
<p>注意，这里要导入的依赖并非是Spring Cloud工程要直接依赖的，而是由于Eureka Server所依赖的。但在JDK9之前，这些依赖是包含在JDK中的，从JDK9开始，JAXB API被划归到了Java EE API,从JDK中踢除了出去。由于本例运行的主机使用的是JDK为10,所以需要导入这些JAXB API依赖。若你使用的是JDK6、7、8，那么这些依赖无需导入。</p>
</blockquote>
<blockquote>
<p>JAXB (Java Architecture for XML Binding, XML绑定的Java技术)是一个业界的标准，是一项可以根据XML Schema产生Java类的技术。该过程中，JAXB也提供了将XML实例文档反向生成Java对象树的方法，并能将Java对象树的内容重新写到XML实例文档。从另一方面来讲，JAXB提供了快速而简便的方法将XML模式绑定到Java表示，从而使得Java开发者在Java应用程序中能方便地结合XML数据和处理函数。</p>
</blockquote>
<pre><code class="highlight xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></code></pre>
<hr />
<p><strong>主配置文件：</strong></p>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">8000</span>
<span class="comment"></span>
<span class="comment">#指定Eureka主机</span>
<span class="attr">eureka.instance.hostname</span>=<span class="string">localhost</span>
<span class="comment"></span>
<span class="comment"># 指定当前主机是否需要向注册中心注册（不用，因为当前主机是Server，不是client）</span>
<span class="attr">eureka.client.register-with-eureka</span>=<span class="string">false</span>
<span class="comment"></span>
<span class="comment">#指定当前主机是否需要获取注册信息（不用，因为当前主机是Server,不是client）</span>
<span class="attr">eureka.client.fetch-registry</span>=<span class="string">false</span>
<span class="comment"></span>
<span class="comment">#暴露服务中心地址</span>
<span class="comment">#使用占位符方式</span>
<span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka</span>
<span class="comment">#普通方式</span>
<span class="comment">#eureka.client.service-url.defaultZone=http://localhost:8000/eureka</span></code></pre>
<h4 id="定义spring-boot启动类"><a class="markdownIt-Anchor" href="#定义spring-boot启动类"></a> 定义spring boot启动类</h4>
<p>添加@EnableEurekaServer注解，开启EurekaServer</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.eurekaserver;

<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaServer</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaserverApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(EurekaserverApplication.class, args);
    &#125;

&#125;
</code></pre>
<h4 id="启动测试"><a class="markdownIt-Anchor" href="#启动测试"></a> 启动测试</h4>
<p>访问：</p>
<pre><code class="highlight plaintext">http://localhost:8000/</code></pre>
<h3 id="修改提供者工程"><a class="markdownIt-Anchor" href="#修改提供者工程"></a> 修改提供者工程</h3>
<p>只需完成三步即可创建一个Eureka服务提供者</p>
<ul>
<li>添加Eureka客户端依赖</li>
<li>在配置文件中指定要注册的Eureka注册中心</li>
<li>在启动类上添加@<strong>EnableEurekaClient</strong>注解</li>
</ul>
<h4 id="pom依赖主配置文件-2"><a class="markdownIt-Anchor" href="#pom依赖主配置文件-2"></a> pom依赖/主配置文件</h4>
<p>pom依赖：</p>
<ul>
<li>添加Eureka客户端依赖和spring cloud dependencyManagement</li>
</ul>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="comment">&lt;!--Eureka客户端依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="comment">&lt;!--修改MySQL驱动版本--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="comment">&lt;!--data数据源阿里巴巴连接池--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>

    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>主配置文件：</strong></p>
<ul>
<li><strong>instance-id</strong>：为客户端微服务在Eureka状态显示栏中显示的名称，若不指定，则默认显示的是该服务提供者 <code>主机名：应用名称：端口号</code></li>
<li><strong><a target="_blank" rel="noopener" href="http://spring.application.name">spring.application.name</a></strong>：指定微服务的名称。若不指定，在Eureka中应用名称位置默认显示Unknown，此名称即为提供者对外暴露的微服务名称，<strong>将来服务消费者就是依据此名称来消费服务的</strong></li>
</ul>
<pre><code class="highlight properties"><span class="comment">#指定端口号</span>
<span class="attr">server.port</span>=<span class="string">8081</span>
<span class="comment">#更改访问上下文路径/访问路径 localhost:8088/leeBoot/...</span>
<span class="comment">#server.servlet.context-path=/springcloudprovider</span>
<span class="comment"></span>
<span class="comment">#开启启动时自动建表</span>
<span class="attr">spring.jpa.generate-ddl</span>=<span class="string">true</span>
<span class="comment">#是否在控制台显示sql语句</span>
<span class="attr">spring.jpa.show-sql</span>=<span class="string">true</span>
<span class="comment">#设置应用启动时不重新建表</span>
<span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">none</span>
<span class="comment"></span>
<span class="comment">#配置数据源</span>
<span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span>
<span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span>
<span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/leetest?characterEncoding=UTF-8</span>
<span class="attr">spring.datasource.username</span>=<span class="string">root</span>
<span class="attr">spring.datasource.password</span>=<span class="string">123456</span>
<span class="comment"></span>
<span class="comment">#配置日志输出格式</span>
<span class="attr">logging.pattern.console</span>=<span class="string">%level %msg%n</span>
<span class="comment">#设置spring boot启动时的日志级别</span>
<span class="attr">logging.level.root</span>=<span class="string">info</span>
<span class="comment">#hibernate运行日志级别   org.gibernate表示类名</span>
<span class="attr">logging.level.org.hibernate</span>=<span class="string">info</span>
<span class="comment">#在show-sql为true时显示sql中的动态参数值</span>
<span class="attr">logging.level.org.hibernate.type.descriptor.sql.BasicBinder</span>=<span class="string">trace</span>
<span class="comment">#在show-sql为true时显示查询结果</span>
<span class="attr">logging.level.org.hibernate.type.descriptor.sql.BasicExtractor</span>=<span class="string">trace</span>
<span class="comment">#控制自己代码运行时显示的日志级别</span>
<span class="attr">logging.level.com.lee</span>=<span class="string">debug</span>
<span class="comment"></span>
<span class="comment">#指定Eureka服务中心（就是eurekaserver项目中的eureka.client.service-url.defaultZone）</span>
<span class="attr">eureka.client.service-url.defaultZone</span>:<span class="string">http://localhost:8000/eureka</span>
<span class="comment">#指定当前客户端在注册中心的名称</span>
<span class="attr">eureka.instance.instance-id</span>=<span class="string">lee-msc-provider-depart-8081</span>
<span class="comment"></span>
<span class="comment">#指定微服务的名称(应用名称)</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-provider-depart</span></code></pre>
<h4 id="修改启动类"><a class="markdownIt-Anchor" href="#修改启动类"></a> 修改启动类</h4>
<p>添加@EnableEurekaClient注解：</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider;

<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;

<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaClient</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ProviderApplication.class, args);
    &#125;
&#125;</code></pre>
<h4 id="启动测试-2"><a class="markdownIt-Anchor" href="#启动测试-2"></a> 启动测试</h4>
<h3 id="actuator完善微服务info"><a class="markdownIt-Anchor" href="#actuator完善微服务info"></a> actuator完善微服务info</h3>
<p>在微服务状态的超链接上点击，可以看到404错误页面，通过地址栏可以看到：<u><a target="_blank" rel="noopener" href="http://localhost:8081/actuator/info">http://localhost:8081/actuator/info</a></u>，因为是由于在配置文件中没有设置actuator的info监控终端所致</p>
<h4 id="提供者添加依赖"><a class="markdownIt-Anchor" href="#提供者添加依赖"></a> 提供者添加依赖</h4>
<p>添加actuator依赖</p>
<pre><code class="highlight xml"><span class="comment">&lt;!--添加actuator依赖--&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></code></pre>
<h4 id="提供者配置文件"><a class="markdownIt-Anchor" href="#提供者配置文件"></a> 提供者配置文件</h4>
<p>在eureka客户端工程中，为服务提供者工程在配置文件的最后添加如下内容：</p>
<ul>
<li>info：是不能变化的，表示这里定义的是info页面内容</li>
<li>二级内容分为key与value，key与value可以任意指定，其显示到页面是以JSON数据的形式出现</li>
<li>二级内容key若只有一级，则其为JSON的key，value为JSON的value</li>
<li>二级内容key若为两级，则第一集为JSON的key，而该JSON的值为JSON数组</li>
</ul>
<pre><code class="highlight properties"><span class="comment">#指定端口号</span>
<span class="attr">server.port</span>=<span class="string">8081</span>
<span class="comment">#更改访问上下文路径/访问路径 localhost:8088/leeBoot/...</span>
<span class="comment">#server.servlet.context-path=/springcloudprovider</span>
<span class="comment"></span>
<span class="comment">#开启启动时自动建表</span>
<span class="attr">spring.jpa.generate-ddl</span>=<span class="string">true</span>
<span class="comment">#是否在控制台显示sql语句</span>
<span class="attr">spring.jpa.show-sql</span>=<span class="string">true</span>
<span class="comment">#设置应用启动时不重新建表</span>
<span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">none</span>
<span class="comment"></span>
<span class="comment">#配置数据源</span>
<span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span>
<span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span>
<span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/leetest?characterEncoding=UTF-8</span>
<span class="attr">spring.datasource.username</span>=<span class="string">root</span>
<span class="attr">spring.datasource.password</span>=<span class="string">123456</span>
<span class="comment"></span>
<span class="comment">#配置日志输出格式</span>
<span class="attr">logging.pattern.console</span>=<span class="string">%level %msg%n</span>
<span class="comment">#设置spring boot启动时的日志级别</span>
<span class="attr">logging.level.root</span>=<span class="string">info</span>
<span class="comment">#hibernate运行日志级别   org.gibernate表示类名</span>
<span class="attr">logging.level.org.hibernate</span>=<span class="string">info</span>
<span class="comment">#在show-sql为true时显示sql中的动态参数值</span>
<span class="attr">logging.level.org.hibernate.type.descriptor.sql.BasicBinder</span>=<span class="string">trace</span>
<span class="comment">#在show-sql为true时显示查询结果</span>
<span class="attr">logging.level.org.hibernate.type.descriptor.sql.BasicExtractor</span>=<span class="string">trace</span>
<span class="comment">#控制自己代码运行时显示的日志级别</span>
<span class="attr">logging.level.com.lee</span>=<span class="string">debug</span>
<span class="comment"></span>
<span class="comment">#指定Eureka服务中心（就是eurekaserver项目中的eureka.client.service-url.defaultZone）</span>
<span class="attr">eureka.client.service-url.defaultZone</span>:<span class="string">http://localhost:8000/eureka</span>
<span class="comment">#指定当前客户端在注册中心的名称</span>
<span class="comment">#eureka.instance.instance-id=lee-msc-provider-depart-8081</span>
<span class="comment"></span>
<span class="comment">#指定微服务的名称(应用名称)</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-provider-depart</span>
<span class="comment"></span>
<span class="comment">#info后面的内容可以随便写</span>
<span class="attr">info.company.name</span>=<span class="string">leeboer.xyz</span>
<span class="attr">info.company.address</span>=<span class="string">xian</span>
<span class="attr">info.company.tel</span>=<span class="string">123456798</span>

<span class="attr">info.app.name</span>=<span class="string">leemsc-provider-depart</span>
<span class="attr">info.app.people</span>=<span class="string">leeboer</span></code></pre>
<h4 id="运行测试"><a class="markdownIt-Anchor" href="#运行测试"></a> 运行测试</h4>
<h3 id="self-preservation机制"><a class="markdownIt-Anchor" href="#self-preservation机制"></a> Self Preservation机制</h3>
<p>Self Preservation机制即自我保护机制，在Eureka服务页面中看到如下红色字体内容，表示当前EurekaServer启动了自我保护机制，进入了自我保护模式</p>
<p>[翻译]紧急情况!当微服务主机联系不上时，Eureka 不能够正确判断它们是否处于up状态。当更新(指收到的微服务主机的心跳)小于阈值时，为了安全，微服务主机将不再失效。</p>
<p>默认情况下，EurekaServer在90秒内没有检测到服务列表中的某微服务，则会自动将该微服务从服务列表中删除。但很多情况下并不是该微服务节点（主机)出了问题，而是由于网络故障或网速等原因使该微服务无法被EurekaServer发现，即无法检测到该微服务主机的心跳。若在短暂时间内网络恢复正常，但由于EurekaServer 的服务列表中已经没有该微服务，所以该微服务已经无法提供服务了。</p>
<p>在短时间内若EurekaServer丢失较多微服务( EurekaServer收到的心跳数量小于阙值)，那么其会自动进入自我保护模式:服务列表只可读取、写入，不可执行删除操作。当EurekaServer收到的心跳数量恢复到阈值以上时，其会自动退出Self Preservation模式(翻译自官网)</p>
<p><strong>Self Preservation机制默认是开启的，可以通过修改EurekaServer中配置文件来关闭</strong>。但建议不关闭</p>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">8000</span>
<span class="comment"></span>
<span class="comment">#指定Eureka主机</span>
<span class="attr">eureka.instance.hostname</span>=<span class="string">localhost</span>
<span class="comment"></span>
<span class="comment">#关闭自我保护机制</span>
<span class="attr">eureka.server.enable-self-preservation</span>=<span class="string">false</span>
<span class="comment"></span>
<span class="comment"># 指定当前主机是否需要向注册中心注册（不用，因为当前主机是Server，不是client）</span>
<span class="attr">eureka.client.register-with-eureka</span>=<span class="string">false</span>
<span class="comment"></span>
<span class="comment">#指定当前主机是否需要获取注册信息（不用，因为当前主机是Server,不是client）</span>
<span class="attr">eureka.client.fetch-registry</span>=<span class="string">false</span>
<span class="comment"></span>
<span class="comment">#暴露服务中心地址</span>
<span class="comment">#使用占位符方式</span>
<span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka</span>
<span class="comment">#普通方式</span>
<span class="comment">#eureka.client.service-url.defaultZone=http://localhost:8000/eureka</span></code></pre>
<h3 id="修改消费者工程"><a class="markdownIt-Anchor" href="#修改消费者工程"></a> 修改消费者工程</h3>
<p>消费者将使用提供者暴露的服务名称（<a target="_blank" rel="noopener" href="http://spring.application.name">spring.application.name</a>）来消费服务</p>
<p>完成以下四个步骤即可创建一个Eureka服务消费者</p>
<ul>
<li>添加Eureka客户端依赖</li>
<li>在配置文件中指定要注册的Eureka注册中心</li>
<li>在CodeConfig类中为RestTemplate添加@LoadBalanced注解</li>
<li>在启动类上添加@EnableEurekaClient</li>
</ul>
<h4 id="添加依赖修改主配置文件"><a class="markdownIt-Anchor" href="#添加依赖修改主配置文件"></a> 添加依赖/修改主配置文件</h4>
<p>pom依赖：</p>
<ul>
<li>添加Eureka客户端依赖和spring cloud dependencyManagement</li>
</ul>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="comment">&lt;!--Eureka客户端依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="comment">&lt;!--添加actuator依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>
    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p>主配置文件：</p>
<pre><code class="highlight properties"><span class="comment">#指定端口号</span>
<span class="attr">server.port</span>=<span class="string">8080</span>
<span class="comment"></span>
<span class="comment">#指定微服务对外暴露的名称</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-consumer-depart</span>
<span class="comment"></span>
<span class="comment">#指定Eureka服务注册中心</span>
<span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:8000/eureka</span></code></pre>
<h4 id="修改configuration类启动类"><a class="markdownIt-Anchor" href="#修改configuration类启动类"></a> 修改Configuration类/启动类</h4>
<p>修改Configuration类:</p>
<ul>
<li>@LoadBalanced：开启消费端的负载均衡功能，默认是轮询策略</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.codeconfig;

<span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;
<span class="keyword">import</span> org.springframework.context.annotation.Bean;
<span class="keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="meta">@Configuration</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartCodeConfig</span> &#123;

    <span class="comment">//开启消费端的负载均衡功能，默认是轮询策略</span>
    <span class="meta">@LoadBalanced</span>
    <span class="meta">@Bean</span>
    <span class="comment">//bean的名称就相当于方法名</span>
    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();
    &#125;
&#125;
</code></pre>
<p>修改启动类：</p>
<ul>
<li>添加@EnableEurekaClient注解</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer;

<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;

<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaClient</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ConsumerApplication.class, args);
    &#125;
&#125;</code></pre>
<h4 id="运行测试-2"><a class="markdownIt-Anchor" href="#运行测试-2"></a> 运行测试</h4>
<h3 id="服务发现discovery"><a class="markdownIt-Anchor" href="#服务发现discovery"></a> 服务发现discovery</h3>
<p>服务发现，即通过“服务发现客户端”，<strong>读取EurekaServer中的服务列表</strong>，获取指定名称的微服务详情</p>
<h4 id="修改处理器"><a class="markdownIt-Anchor" href="#修改处理器"></a> 修改处理器</h4>
<p>在<strong>任何</strong>微服务的<strong>提供者或者消费者</strong>处理器中，只要获取到“服务发现Client”，即可读取到EurekaServer的微服务列表</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider.Controller;

<span class="keyword">import</span> com.lee.provider.bean.Depart;
<span class="keyword">import</span> com.lee.provider.service.DepartService;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;
<span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="keyword">import</span> java.util.List;

<span class="meta">@RequestMapping(&quot;/provider/depart&quot;)</span>
<span class="meta">@RestController</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartController</span> &#123;
    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> DepartService service;

    <span class="comment">//获取服务发现客户端</span>
    <span class="meta">@Autowired</span>
    <span class="keyword">private</span> DiscoveryClient client;

    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="comment">//@RequestBody表示传过来的数据时json数据</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveHandle</span><span class="params">(<span class="meta">@RequestBody</span> Depart depart)</span> &#123;
        <span class="keyword">return</span> service.saveDepart(depart);
    &#125;

    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="comment">//@PathVariable 表示获取url中的&#123;id&#125;的值</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteHandle</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;
        <span class="keyword">return</span> service.removeDepartById(id);
    &#125;

    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateHandle</span><span class="params">(<span class="meta">@RequestBody</span> Depart depart)</span>&#123;
        <span class="keyword">return</span> service.modifyDepart(depart);
    &#125;

    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    <span class="keyword">public</span> Depart <span class="title function_">GetHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span>&#123;
        <span class="keyword">return</span> service.getDepartById(id);
    &#125;

    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listHandle</span><span class="params">()</span> &#123;
        <span class="keyword">return</span> service.listAllDeparts();
    &#125;

    <span class="meta">@GetMapping(&quot;/discovery&quot;)</span>
    <span class="keyword">public</span> Object <span class="title function_">discoverHandler</span><span class="params">()</span>&#123;
        <span class="comment">//获取服务注册列表中所有微服务名称</span>
        List&lt;String&gt; springApplicationNames = client.getServices();
        <span class="keyword">for</span> (String name : springApplicationNames) &#123;
            <span class="comment">//获取提供指定微服务名称服务的所有提供者主机（因为服务提供者的主机不仅仅是一台）</span>
            List&lt;ServiceInstance&gt; instances = client.getInstances(name);
            <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;
                System.out.println(instance.getHost()+<span class="string">&quot; : &quot;</span>+instance.getPort());
            &#125;
        &#125;
        <span class="keyword">return</span> springApplicationNames;
    &#125;
&#125;
</code></pre>
<h4 id="启动类添加注解"><a class="markdownIt-Anchor" href="#启动类添加注解"></a> 启动类添加注解</h4>
<p>添加@EnableDiscoveryClient，开启服务发现客户端</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.provider;

<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;

<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaClient</span>
<span class="meta">@EnableDiscoveryClient</span>  <span class="comment">//开启服务发现客户端</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ProviderApplication.class, args);
    &#125;
&#125;</code></pre>
<h4 id="运行测试-3"><a class="markdownIt-Anchor" href="#运行测试-3"></a> 运行测试</h4>
<p>浏览器输出：</p>
<p>控制台输出:</p>
<h3 id="eurekaserver集群"><a class="markdownIt-Anchor" href="#eurekaserver集群"></a> EurekaServer集群</h3>
<p>单个EurekaServer不仅吞吐量有限，还存在单点问题，所以我们会使用EurekaServer集群，这里要搭建的EurekaServer集群中包含三个EurekaServer节点，其端口号分别为8100，8200，8300</p>
<h4 id="修改eurekaserver"><a class="markdownIt-Anchor" href="#修改eurekaserver"></a> 修改EurekaServer</h4>
<p>要想搭建EurekaServer，需在三台服务器启动EurekaServer，EurekaServer的改动如下：</p>
<ul>
<li>只需在<code>eureka.client.service-url.defaultZone</code>中指定所有的服务中心的地址即可，每个服务中心之间用逗号隔开</li>
</ul>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">8000</span>
<span class="comment"></span>
<span class="comment">#指定Eureka主机</span>
<span class="attr">eureka.instance.hostname</span>=<span class="string">192.168.1.1</span>
<span class="comment"></span>
<span class="comment">#关闭自我保护机制</span>
<span class="comment">#eureka.server.enable-self-preservation=false</span>
<span class="comment"></span>
<span class="comment"># 指定当前主机是否需要向注册中心注册（不用，因为当前主机是Server，不是client）</span>
<span class="attr">eureka.client.register-with-eureka</span>=<span class="string">false</span>
<span class="comment"></span>
<span class="comment">#指定当前主机是否需要获取注册信息（不用，因为当前主机是Server,不是client）</span>
<span class="attr">eureka.client.fetch-registry</span>=<span class="string">false</span>
<span class="comment"></span>
<span class="comment">#暴露服务中心地址</span>
<span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://192.168.1.1:8000/eureka,http://192.168.1.2:8000/eureka,http://192.168.1.3:8000/eureka</span></code></pre>
<h4 id="服务提供者服务消费者"><a class="markdownIt-Anchor" href="#服务提供者服务消费者"></a> 服务提供者/服务消费者</h4>
<p>服务提供者/服务消费者要想访问集群，也只需修改<code>eureka.client.service-url.defaultZone</code>即可</p>
<pre><code class="highlight properties"><span class="comment">#指定Eureka服务注册中心</span>
<span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://192.168.1.1:8000/eureka,http://192.168.1.2:8000/eureka,http://192.168.1.3:8000/eureka</span></code></pre>
<h3 id="eureka与zookeeper对比"><a class="markdownIt-Anchor" href="#eureka与zookeeper对比"></a> Eureka与Zookeeper对比</h3>
<h4 id="eureka与ap原则"><a class="markdownIt-Anchor" href="#eureka与ap原则"></a> eureka与AP原则</h4>
<p>Eureka在CAP原则中遵循的是AP原则，即保证了可用性，牺牲了一致性。</p>
<p>Eureka Server集群中各个节点都是平等的，不像zk集群中还存在Leader与Follower.每个Eureka Server节点都具有向客户端响应读写操作的功能。只要不是出现集群中所有节点都宕机的情况，Eureka的服务注册与发现功能就不会停止。即使所有Eureka Server都宕机了，Eureka Client通过其缓存机制仍可对外提供服务发现功能，虽然此时已经不能再进行服务注册了。这保证了可用性。</p>
<p>当某一个Eureka集群节点中数据更新了，其会向其它节点发出广播，让其同步数据。但同步数据之前及之间，尚未更新数据的节点并不会停止服务，其依然可以进行服务的注册与发现。只不过其服务列表中的数据不能保证是最新的。从这点可知，Eureka通过牺牲一致性，保证了可用性。</p>
<p>Eureka为了保证可用性，启用了Self Preservation自我保护机制。自我保护机制一旦启动，Eureka将不再从服务列表中删除长时间没有收到心跳的服务:此时的Eureka虽然仍可以接受新的服务注册与发现，但不会被同步到其它节点。当网络稳定时，当前Eureka实例新的数据信息就会被同步到其它节点中。</p>
<h4 id="zookeer与cp原则"><a class="markdownIt-Anchor" href="#zookeer与cp原则"></a> Zookeer与CP原则</h4>
<p>zk遵循的是CP原则，即保证了一致性，但牺牲了可用性。体现在哪里呢?</p>
<p>当Leader宕机后，zk集群会马上进行新的Leader的选举。但选举选举时长在30-120秒间，整个选举期间zk集群是不接受客户端的读写操作的，即zk集群是处于瘫痪状态的。所以，其不满足可用性。</p>
<p>为什么Leader的选举需要这么长的时间呢?为了保证zk集群各个节点中数据的一致性，zk集群做了两类数据同步:初始化同步与更新同步。当新的Leader被选举出后，各个Follower需要将新Leader的数据同步到自己的缓存中，这是初始化同步，当Leader的数据被客户端修改后，其会向Follower发出广播，然后各个Follower会主动同步Leader的更新数据，这是更新同步。无论是初始化同步还是更新同步，zk集群为了保证数据的一致性，若发现超过半数的Follower同步超时，则其会再次进行同步，而这个过程中zk集群是处于不对外提供服务状态。</p>
<h2 id="声明式rest客户端openfeign"><a class="markdownIt-Anchor" href="#声明式rest客户端openfeign"></a> 声明式REST客户端OpenFeign</h2>
<h3 id="openfeign概述"><a class="markdownIt-Anchor" href="#openfeign概述"></a> OpenFeign概述</h3>
<p>本项目通过自动配置和绑定到Spring环境和其他Spring编程模型习惯用法，为Spring引导应用程序提供OpenFeign集成</p>
<p><strong>功能</strong></p>
<p>声明式REST客户端：Feign创建一个使用JAX-RS或Spring MVC注解修饰的接口的动态实现</p>
<h4 id="openfeign与feign"><a class="markdownIt-Anchor" href="#openfeign与feign"></a> OpenFeign与Feign</h4>
<p>Spring Boot 1.x及Spring Cloud之前的版本环境下使用的是Feign，而该项目现已更新了OpenFeign，所以后续使用的依赖也发生了变化</p>
<pre><code class="highlight xml"><span class="comment">&lt;!--openfeign依赖--&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

<span class="comment">&lt;!--feign依赖--&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></code></pre>
<h4 id="ribbon简介"><a class="markdownIt-Anchor" href="#ribbon简介"></a> Ribbon简介</h4>
<p>Ribbon是Netflix公司开源的一个负载均衡的项目，是一个客户端负载均衡器，运行在消费者端，当然，一定是Eureka客户端</p>
<p><strong>Ribbon与OpenFeign</strong></p>
<p>OpenFeign中使用Ribbon进行负载均衡，所以OpenFeign直接内置了Ribbon，即在导入OpenFeign依赖后，无需再专门导入Ribbon依赖了</p>
<h3 id="修改消费者工程-2"><a class="markdownIt-Anchor" href="#修改消费者工程-2"></a> 修改消费者工程</h3>
<p>这里无需修改提供者工程，只需修改消费者工程即可</p>
<p>需完成四部即可使用feign接口消费微服务：</p>
<ul>
<li>添加openfeign依赖</li>
<li>定义Service接口，并用@FeignClient指定其所绑定的微服务名（即服务提供者的applicationName）</li>
<li>修改处理器，通过Service接口消费微服务</li>
<li>在启动类上添加@EnableFeignClients注解</li>
</ul>
<blockquote>
<p>不要忘记在主配置文件修改<strong>统一</strong>的服务提供者和服务消费者的服务注册中心</p>
</blockquote>
<p><strong>pom依赖</strong></p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="comment">&lt;!--Eureka客户端依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="comment">&lt;!--添加actuator依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="comment">&lt;!--添加OpenFeign依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>
    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>定义Service接口</strong></p>
<ul>
<li>@FeignClient：指定当前service所绑定的提供者微服务的名称</li>
<li>所有的@XXXMapping相关注解与服务提供者的Controller一一对应，就相当于我们消费者的接口实现是服务提供者的Controller</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.service;

<span class="keyword">import</span> com.lee.consumer.bean.Depart;
<span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="keyword">import</span> java.util.List;

<span class="comment">//指定当前service所绑定的提供者微服务的名称</span>
<span class="meta">@FeignClient(&quot;leemsc-provider-depart&quot;)</span>
<span class="meta">@RequestMapping(&quot;/provider/depart&quot;)</span>
<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DepartService</span> &#123;
    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="type">boolean</span> <span class="title function_">saveDepart</span><span class="params">(Depart depart)</span>;
    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="type">boolean</span> <span class="title function_">removeDepartById</span><span class="params">(<span class="meta">@PathVariable</span>  <span class="type">int</span> id)</span>;
    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="type">boolean</span> <span class="title function_">modifyDepart</span><span class="params">(Depart depart)</span>;
    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    Depart <span class="title function_">getDepartById</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span>;
    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    List&lt;Depart&gt; <span class="title function_">listAllDeparts</span><span class="params">()</span>;
&#125;
</code></pre>
<p><strong>修改处理器类</strong></p>
<ul>
<li>使用feign风格的service，不再使用RestTemplate</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.Controller;

<span class="keyword">import</span> com.lee.consumer.bean.Depart;
<span class="keyword">import</span> com.lee.consumer.service.DepartService;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="keyword">import</span> java.util.List;

<span class="comment">/**</span>
<span class="comment"> * 使用openFeign后，不用再使用RestTemplate，编程风格和以前一样了</span>
<span class="comment"> */</span>
<span class="meta">@RestController</span>
<span class="meta">@RequestMapping(&quot;/consumer/depart&quot;)</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartController</span> &#123;

    <span class="meta">@Autowired</span>
    <span class="comment">//这里不再注入RestTemplate，注入service接口</span>
    <span class="keyword">private</span> DepartService service;

    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="keyword">return</span> service.saveDepart(depart);
    &#125;

    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="comment">//@PathVariable 表示获取url中的&#123;id&#125;的值</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteHandle</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;
        <span class="keyword">return</span> service.removeDepartById(id);
    &#125;


    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="keyword">return</span> service.modifyDepart(depart);
    &#125;

    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    <span class="keyword">public</span> Depart <span class="title function_">GetHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span> &#123;
        <span class="keyword">return</span> service.getDepartById(id);
    &#125;

    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listHandle</span><span class="params">()</span> &#123;
        <span class="keyword">return</span> service.listAllDeparts();
    &#125;

&#125;
</code></pre>
<p><strong>修改启动类</strong></p>
<ul>
<li>@EnableFeignClients：开启feign客户端，指定service接口所在包</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer;

<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;
<span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;

<span class="comment">//开启feign客户端，指定service接口所在包</span>
<span class="meta">@EnableFeignClients(basePackages = &quot;com.lee.consumer.service&quot;)</span>
<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaClient</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ConsumerApplication.class, args);
    &#125;

&#125;
</code></pre>
<p><strong>运行测试</strong></p>
<h3 id="ribbon负载均衡展示"><a class="markdownIt-Anchor" href="#ribbon负载均衡展示"></a> Ribbon负载均衡展示</h3>
<p>前面的消费者例子是通过feign接口来消费微服务的，但没体现出负载均衡的功能，所以，下面将进行Feign负载均衡的功能展示</p>
<h4 id="系统结构"><a class="markdownIt-Anchor" href="#系统结构"></a> 系统结构</h4>
<p>负载均衡能力的展示需要搭建出多个服务提供者。下面将构建这样一一个系统:一一个微服务由三个提供者提供，而消费者使用Ribbon对这三个提供者进行负载均衡访问。Ribbon 首先会选择同一区域内访问量较少的EurekaServer,然后再从该EurekaServer中获取到服务列表，然后再根据用户指定的负载均衡策略选择-一个服务提供者。</p>
<h4 id="项目搭建"><a class="markdownIt-Anchor" href="#项目搭建"></a> 项目搭建</h4>
<p>首先我们需要创建三个服务名相同，使用数据库不同的服务提供者，我们只需要把之前的服务提供者复制三分，然后分别修改以下内容</p>
<ul>
<li><strong>创建数据库</strong>：让每一个服务提供者都访问自己的数据库（即分别创建三个database）</li>
<li><strong>修改配置文件</strong>：
<ul>
<li>当前工程的端口号，8080，8081，8082</li>
<li>自己要连接的数据库database名</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意：服务名称不可以修改，因为消费者是通过该名称来进行负载均衡服务消费的</p>
</blockquote>
<p><strong>测试</strong></p>
<p>分别启动三个服务提供者，启动一个eurekaserver，再启动服务消费者，查看Eureka服务中心：</p>
<p>我们调用服务消费者（Eureka client端）的Controller时，可以发现，默认负载均衡算法时分别调用三个服务提供者，因为<strong>默认负载均衡算法为轮询算法</strong></p>
<h3 id="ribbon负载均衡算法irule"><a class="markdownIt-Anchor" href="#ribbon负载均衡算法irule"></a> Ribbon负载均衡算法IRule</h3>
<p>Ribbon提供了多种负载均衡策略算法，例如轮询算法、随机算法、响应时间加权算法等。默认采用的是轮询算法。当然，我们也可以指定Ribbon所要采用的负载均衡算法。</p>
<h4 id="ribbon接口"><a class="markdownIt-Anchor" href="#ribbon接口"></a> Ribbon接口</h4>
<p>IRule接口的实现类就是Ribbon默认的几种负载均衡算法；</p>
<p><strong>choose0方法</strong></p>
<p><strong>Ribbon的负载均衡算法需要实现lRule接口</strong>，而该接口中的核心方法即choose()方法，即对提供者的选择方式就是在该方法中体现的。</p>
<p>查看该方法的注释，其意思是“根据key的值从alservers或upServers集合中选择一个可用的Server”。allServers是所有提供者集合，而upServers则是所有可用的提供者集合。choose()方法的参数key是集合选择的标准。</p>
<pre><code class="highlight java">
<span class="keyword">package</span> com.netflix.loadbalancer;

<span class="comment">/**</span>
<span class="comment"> * Interface that defines a &quot;Rule&quot; for a LoadBalancer. A Rule can be thought of</span>
<span class="comment"> * as a Strategy for loadbalacing. Well known loadbalancing strategies include</span>
<span class="comment"> * Round Robin, Response Time based etc.</span>
<span class="comment"> * </span>
<span class="comment"> * <span class="doctag">@author</span> stonse</span>
<span class="comment"> * </span>
<span class="comment"> */</span>
<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRule</span>&#123;
    <span class="comment">/*</span>
<span class="comment">     * choose one alive server from lb.allServers or</span>
<span class="comment">     * lb.upServers according to key</span>
<span class="comment">     * </span>
<span class="comment">     * @return choosen Server object. NULL is returned if none</span>
<span class="comment">     *  server is available </span>
<span class="comment">     */</span>

    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span>;
    
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoadBalancer</span><span class="params">(ILoadBalancer lb)</span>;
    
    <span class="keyword">public</span> ILoadBalancer <span class="title function_">getLoadBalancer</span><span class="params">()</span>;    
&#125;
</code></pre>
<blockquote>
<p>不过，从ribbon2.0开始，该key就被固定为“default”了，即该参数已经失去了实际的意义了，打开iRibbonLoadBalanceClient类的getServer()方法，可以看到其调用了loadBalancer的choose()方法，实参为&quot;default&quot;</p>
</blockquote>
<h4 id="ribbon自带算法"><a class="markdownIt-Anchor" href="#ribbon自带算法"></a> Ribbon自带算法</h4>
<p>Ribbon的内置可用负载均衡算法有七种</p>
<p><strong>RoundRobinRule</strong></p>
<p>轮询算法，Ribbon默认采用的策略</p>
<p><strong>BestAvailableRule</strong></p>
<p>选择并发量最小的provider，即连接的消费者数量最少的provider，其会遍历服务列表中的每一个provide，选择当前连接数量minimalConcurrentConnections最小的provider</p>
<p><strong>AvailabilityFilteringRule</strong></p>
<p>过滤掉由于连续连接或读故障而处于断路器跳闸状态的provide，或已经超过连接极限的provide，对剩余provide采用轮询策略</p>
<p><strong>ZoneAvoidanceRule</strong></p>
<p>复合判断provider所在区域的性能及provider的可用性选择服务器</p>
<p><strong>RandomRule</strong></p>
<p>随机策略，从所有可用的provide中随机选择一个</p>
<p><strong>RetryRule</strong></p>
<p>先按照RoundRobinRule策略获取provider，若获取失败，则再指定的时限内重试，默认的时限为500毫秒</p>
<p><strong>WeightedResponseTimeRule</strong></p>
<p>&quot;权重响应时间&quot;策略，根据每个provide的平均响应时间计算其权重，响应时间越快权重越大，被选中的几率就越高，再刚启动时采用轮询策略，后面就会根据权重进行选择了</p>
<h4 id="更换默认策略"><a class="markdownIt-Anchor" href="#更换默认策略"></a> 更换默认策略</h4>
<p>Ribbon默认采用的是RoundRobinRule，即轮询策略，但通过修改消费者的启动类或者codeConfig类可以实现更换负载均衡策略的目的：只需添加如下代码即可：</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer;

<span class="keyword">import</span> com.netflix.loadbalancer.IRule;
<span class="keyword">import</span> com.netflix.loadbalancer.RandomRule;
<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;
<span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;
<span class="keyword">import</span> org.springframework.context.annotation.Bean;

<span class="comment">//开启feign客户端，指定service接口所在包</span>
<span class="meta">@EnableFeignClients(basePackages = &quot;com.lee.consumer.service&quot;)</span>
<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaClient</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ConsumerApplication.class, args);
    &#125;

    <span class="comment">//指定Ribbon使用&quot;随机算法策略&quot;</span>
    <span class="meta">@Bean</span>
    <span class="keyword">public</span> IRule <span class="title function_">LoadBalanceRule</span><span class="params">()</span>&#123;
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();
    &#125;
&#125;
</code></pre>
<h4 id="自定义负载均衡策略"><a class="markdownIt-Anchor" href="#自定义负载均衡策略"></a> 自定义负载均衡策略</h4>
<p>该负载均衡策略的思路是：从所有可用的provider中排除掉指定端口号的provider，剩余的provide随机选择</p>
<pre><code class="highlight java"><span class="keyword">package</span> rule;

<span class="keyword">import</span> com.netflix.loadbalancer.ILoadBalancer;
<span class="keyword">import</span> com.netflix.loadbalancer.IRule;
<span class="keyword">import</span> com.netflix.loadbalancer.Server;

<span class="keyword">import</span> java.util.Iterator;
<span class="keyword">import</span> java.util.List;
<span class="keyword">import</span> java.util.Random;

<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomRule</span> <span class="keyword">implements</span> <span class="title class_">IRule</span> &#123;
    ILoadBalancer lb;

    <span class="comment">//要排除的提供者端口号集合</span>
    <span class="keyword">private</span> List&lt;Integer&gt; excludePorts;

    <span class="keyword">public</span> <span class="title function_">CustomRule</span><span class="params">()</span> &#123;
    &#125;

    <span class="comment">//从构造函数中传入要排除的端口号集合</span>
    <span class="keyword">public</span> <span class="title function_">CustomRule</span><span class="params">(List&lt;Integer&gt; excludePorts)</span> &#123;
        <span class="built_in">this</span>.excludePorts = excludePorts;
    &#125;

    <span class="meta">@Override</span>
    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span> &#123;
        <span class="comment">//获取所有可用的提供者</span>
        List&lt;Server&gt; servers = lb.getReachableServers();
        <span class="comment">//获取所有排除了指定端口号的提供者</span>
        List&lt;Server&gt; availableServices = <span class="built_in">this</span>.getAvailableServices(servers);
        <span class="comment">//从剩余的提供者中随机获取可用的提供者</span>
        <span class="keyword">return</span> <span class="built_in">this</span>.getAvailableRandomServices(availableServices);
    &#125;

    <span class="comment">//获取所有排除了指定端口号的提供者</span>
    <span class="keyword">private</span> List&lt;Server&gt; <span class="title function_">getAvailableServices</span><span class="params">(List&lt;Server&gt; servers)</span> &#123;
        <span class="keyword">if</span> (excludePorts == <span class="literal">null</span> || excludePorts.size() == <span class="number">0</span>) &#123;
            <span class="keyword">return</span> servers;
        &#125;

        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; servers.size(); i++) &#123;
            <span class="keyword">for</span> (Integer port : excludePorts) &#123;
                <span class="keyword">if</span> (port.equals(servers.get(i).getPort())) &#123;
                    servers.remove(i);
                    <span class="keyword">break</span>;
                &#125;
            &#125;
        &#125;
        <span class="keyword">return</span> servers;
    &#125;

    <span class="comment">//从剩余的提供者中随机获取可用的提供者</span>
    <span class="keyword">private</span> Server <span class="title function_">getAvailableRandomServices</span><span class="params">(List&lt;Server&gt; servers)</span> &#123;
        <span class="comment">//获取一个[0，servers.size() )的随机整数</span>
        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(servers.size());
        <span class="keyword">return</span> servers.get(index);
    &#125;


    <span class="meta">@Override</span>
    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoadBalancer</span><span class="params">(ILoadBalancer lb)</span> &#123;
        <span class="built_in">this</span>.lb = lb;
    &#125;

    <span class="meta">@Override</span>
    <span class="keyword">public</span> ILoadBalancer <span class="title function_">getLoadBalancer</span><span class="params">()</span> &#123;
        <span class="keyword">return</span> <span class="built_in">this</span>.lb;
    &#125;
&#125;
</code></pre>
<p>然后再启动类或者@Configuration声明的类给spring注入我们自定义的负载均衡规则</p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer;

<span class="keyword">import</span> com.netflix.loadbalancer.IRule;
<span class="keyword">import</span> com.netflix.loadbalancer.RandomRule;
<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;
<span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;
<span class="keyword">import</span> org.springframework.context.annotation.Bean;
<span class="keyword">import</span> rule.CustomRule;

<span class="keyword">import</span> java.util.ArrayList;
<span class="keyword">import</span> java.util.List;

<span class="comment">//开启feign客户端，指定service接口所在包</span>
<span class="meta">@EnableFeignClients(basePackages = &quot;com.lee.consumer.service&quot;)</span>
<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaClient</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ConsumerApplication.class, args);
    &#125;

<span class="comment">//    //指定Ribbon使用&quot;随机算法策略&quot;</span>
<span class="comment">//    @Bean</span>
<span class="comment">//    public IRule LoadBalanceRule()&#123;</span>
<span class="comment">//        return new RandomRule();</span>
<span class="comment">//    &#125;</span>

    <span class="comment">//指定Ribbon使用&quot;自定义的负载均衡算法策略&quot;</span>
    <span class="meta">@Bean</span>
    <span class="keyword">public</span> IRule <span class="title function_">LoadBalanceRule</span><span class="params">()</span>&#123;
        List&lt;Integer&gt; ports = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();
        ports.add(<span class="number">8081</span>);
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomRule</span>(ports);
    &#125;
&#125;
</code></pre>
<h2 id="hystrix熔断机制与服务降级"><a class="markdownIt-Anchor" href="#hystrix熔断机制与服务降级"></a> Hystrix熔断机制与服务降级</h2>
<h3 id="服务熔断简介"><a class="markdownIt-Anchor" href="#服务熔断简介"></a> 服务熔断简介</h3>
<p>若要了解服务熔断，需要先了解雪崩效应和服务雪崩</p>
<p><strong>雪崩效应</strong></p>
<p>分布式系统中很容易出现雪崩效应</p>
<p>在IO型服务中，假设服务A依赖服务B和服务C，而B服务和C服务有可能继续依赖其他的服务，继续下去会使得调用链路过长，技术上称1-&gt;N扇出</p>
<p>如果在A的链路上某个或几个被调用的子服务不可用或延迟较高，则会导致调用A服务的请求被堵住。</p>
<p>堵住的A请求会消耗占用系统的线程、10等资源，当对A服务的请求越来越多，占用的计算机资源越来越多的时候，会导致系统瓶颈出现，造成其他的请求同样不可用，最终导致业务系统崩溃，这种现象称为雪崩效应。</p>
<p>例如一个汽车生产线，生产不同的汽车，需要使用不同的零件。如果某个零件因为种种原因无法及时供给，而没有该零件，则后续的好多已经到货的零件也无法安装。一个零件的缺失造成整台车无法装配，陷入等待零件的状态，直到零件到位，才能继续组装。</p>
<p>此时如果有很多个车型都需要这个零件，那么整个工厂都将陷入等待的状态，而前述已经生成好的汽车部件，及暂不能安装的其它零件,将由于等待而占用大量资金、厂地等资源。一个零件最终导致所有的生产陷入瘫痪，这就是雪崩效应。</p>
<p><strong>服务雪崩</strong></p>
<p>雪崩效应发生在分布式（Service-Oriented Architecture，面向服务的架构）系统中，则称为服务雪崩</p>
<p>上图是用户请求多个服务（A,H,I,P）均能正常访问并返回的情况</p>
<p>上图为请求服务I出现问题时，一个用户请求被阻塞的情况</p>
<p>上图为大量用户请求服务I出现异常全部陷入阻塞的情况，即发生服务血崩的情况</p>
<p>举个例子，一个依赖30个微服务的系统，每个服务99 99%可用。则整个系统的可用性为99.99%的30次方，约为99.7%。为什么是30次方呢?若系统依赖于2个微服务，个微服务的可用率为99.99%，那么，两个微服务的组合的可用率为99.99%* 99.99%，同理，30个微服务，每个微服务的可用率为99.99%，则这30个微服务组合后的可用性为99.99%的30次方。</p>
<p>也就是说，整个系统会存在0.3%的失败率。若存在一亿次请求，那么将会有30万次失败。随着随着服务依赖数量的增多，服务不稳定的概率会成指数性升高。</p>
<p><strong>熔断机制</strong></p>
<p>熔断机制是服务雪崩的一种有效解决方案。当服务消费者所请求的提供者暂不能提供服务时，消费者会被阻塞，且长时间占用请求链路。为I防止这种情况的发生，当在设定阈值时限到达时仍未获得提供者的服务，则系统将通过断路器直接将此请求链路断开。这种像熔断“保险丝”一样的解决方案称为熔断机制。</p>
<h3 id="hystrix简介"><a class="markdownIt-Anchor" href="#hystrix简介"></a> Hystrix简介</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/netflix/hystrix">官网：https://github.com/netflix/hystrix</a></p>
<p>在分布式环境中，其所依赖的一些服务出现失败是不可避免的。Hystrix是一一个通过添加容延逻辑与容错逻辑来控制这些分布式服务间相互影响的库。Hystrix通过隔离服务间的访问点、停止服务间的级联失败，及提供回退选项，来提升系统的整体弹性。</p>
<p><strong>综合说明</strong></p>
<p>在一个分布式系统里,许多服务不可避免的会出现调用失败的情况，比如超时、异常等。如何能够保证在一个服务出问题的情况下，不会导致整个系统瘫痪，这个就是Hystrix需要做的事情。Hystrix提供了熔断、隔离、Fallback、cache、 监控等功能，能够在-一个或多个服务同时出现问题时保证系统依然可用。</p>
<p>Hystrix是种开关装置， 类似于熔断保险丝。当Hystrix 监控到某个服务发生故障后，其不会让该服务的消费者阻塞，或向消费者抛出异常，而是向消费者返回一个符合预期的、可处理的备选响应（FallBack）,这样就避免了服务雪崩的发生</p>
<h3 id="服务降级简介"><a class="markdownIt-Anchor" href="#服务降级简介"></a> 服务降级简介</h3>
<p>在访问分布式系统中，经常会发生以下两种情况:</p>
<ul>
<li>当整个微服务架构整体的负载超出了预设的上限阈值，或即将到来的流量预计将会超过预设的阈值时，为了保证重要或基本的服务能正常运行，我们可以将一些不重要或不紧急的服务进行延迟使用或暂停使用。这就是服务熔断，类似于主动拉电闸的服务熔断。此时，若有消费者消费这些延迟/暂停使用的服务则会出现阻塞，等待提供者的响应</li>
<li>当消费者访问某微服务时，由于网络或其它原因，提供者向消费者响应过慢，出现服务超时或根本就没有响应时，这也是一种服务熔断，类似于保险丝自动熔断的服务熔断。此时消费者会被迫阻塞，等待提供者的响应。</li>
</ul>
<p>在发生服务熔断时，不仅用户体验很差，其还占用了大量的系统资源。为了解决这个问题，在编写消费者端代码时就设置了预案:在消费者端给出一种默认的、临时的处理方案，能够给出消费者一个可以接受的结果。即，对于用户(指的是人，并非指消费者端)来说，其所消费的服务并非由应当提供服务的提供者端给出，而是由服务消费者临时给出，服务质量降级了。这就是“服务降级”，提供者端的&quot;服务熔断&quot;与消费者端的&quot;本地服务&quot;共同构成了&quot;服务降级&quot;</p>
<p><strong>简单来说服务降级指的是</strong>：当服务的提供者无法正常提供服务时，为了增加用户体验，保证整个系统能够正常运行，由服务消费者端调用本地操作，暂时给出用户响应结果的情况.</p>
<h3 id="hystrix服务降级方法级别"><a class="markdownIt-Anchor" href="#hystrix服务降级方法级别"></a> Hystrix服务降级（方法级别）</h3>
<p><strong>服务降级是针对消费者端的，和提供者没有任何关系</strong></p>
<p>无论消费者是通过RestTemplate消费微服务的，还是通过Feign接口消费微服务的，使用Hystrix的方法都一样，Hystrix与Feign之间并没有依赖关系</p>
<ul>
<li>添加hystrix依赖</li>
<li>修改处理器，在<strong>处理器方法</strong>上添加@HystrixCommand注解，并添加相应的Hystrix处理方法</li>
<li>在启动类上添加@EnableCircuitBreaker注解</li>
</ul>
<p><strong>pom依赖</strong></p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="comment">&lt;!--Eureka客户端依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="comment">&lt;!--添加actuator依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="comment">&lt;!--添加OpenFeign依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="comment">&lt;!--hystrix依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>


        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>
    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>处理器方法：</strong></p>
<ul>
<li>断路打开后，可用避免连锁故障，fallback方法可以直接返回一个固定值</li>
<li>方法上加上@HystrixCommand注解。该注解对该方法创建了熔断器的功能，并指定了fallbackMethod熔断方法</li>
<li>这就说明当服务提供者工程不可用的时候，消费者调用服务提供者的API接口时，会执行快速失败，直接返回一组字符串，而不是等待响应超时，这很好的控制了容器的线程阻塞</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.Controller;

<span class="keyword">import</span> com.lee.consumer.bean.Depart;
<span class="keyword">import</span> com.lee.consumer.service.DepartService;
<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="keyword">import</span> java.util.List;

<span class="comment">/**</span>
<span class="comment"> * 使用openFeign后，不用再使用RestTemplate，编程风格和以前一样了</span>
<span class="comment"> */</span>
<span class="meta">@RestController</span>
<span class="meta">@RequestMapping(&quot;/consumer/depart&quot;)</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartController</span> &#123;

    <span class="meta">@Autowired</span>
    <span class="comment">//这里不再注入RestTemplate，注入service接口</span>
    <span class="keyword">private</span> DepartService service;

    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="keyword">return</span> service.saveDepart(depart);
    &#125;

    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="comment">//@PathVariable 表示获取url中的&#123;id&#125;的值</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteHandle</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;
        <span class="keyword">return</span> service.removeDepartById(id);
    &#125;


    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="keyword">return</span> service.modifyDepart(depart);
    &#125;

    <span class="comment">//方法级别的服务降级</span>
    <span class="meta">@HystrixCommand(fallbackMethod = &quot;getHystrixHandle&quot;)</span>
    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    <span class="keyword">public</span> Depart <span class="title function_">GetHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span> <span class="keyword">throws</span> InterruptedException &#123;

        <span class="type">Depart</span> <span class="variable">depart</span> <span class="operator">=</span>  service.getDepartById(id);
        <span class="comment">//如果是服务端产生的异常则由类级别进行服务降级</span>
        <span class="comment">//在这个方法中抛出的异常由方法级别进行服务降级</span>
        <span class="comment">//模拟服务端调用延时，测试服务降级</span>
        Thread.sleep(<span class="number">5100</span>);
        <span class="keyword">return</span> depart;
    &#125;

    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listHandle</span><span class="params">()</span> &#123;
        <span class="keyword">return</span> service.listAllDeparts();
    &#125;

    <span class="comment">//当@HystrixCommand标注的方法不能正常访问时调用此方法</span>
    <span class="keyword">public</span> Depart <span class="title function_">getHystrixHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span>&#123;
        <span class="type">Depart</span> <span class="variable">depart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Depart</span>();
        depart.setId(id);
        depart.setName(<span class="string">&quot;no this depart&quot;</span>);
        depart.setDbase(<span class="string">&quot;no this db&quot;</span>);
        System.out.println(<span class="string">&quot;方法降级++++&quot;</span>);
        <span class="keyword">return</span> depart;
    &#125;

&#125;
</code></pre>
<p><strong>修改启动类：</strong></p>
<pre><code class="highlight java">
<span class="keyword">package</span> com.lee.consumer;

<span class="keyword">import</span> com.netflix.loadbalancer.IRule;
<span class="keyword">import</span> com.netflix.loadbalancer.RandomRule;
<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
<span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;
<span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;
<span class="keyword">import</span> org.springframework.context.annotation.Bean;
<span class="keyword">import</span> rule.CustomRule;

<span class="keyword">import</span> java.util.ArrayList;
<span class="keyword">import</span> java.util.List;

<span class="comment">//开启服务降级</span>
<span class="meta">@EnableCircuitBreaker</span>
<span class="comment">//开启feign客户端，指定service接口所在包</span>
<span class="meta">@EnableFeignClients(basePackages = &quot;com.lee.consumer.service&quot;)</span>
<span class="meta">@SpringBootApplication</span>
<span class="meta">@EnableEurekaClient</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ConsumerApplication.class, args);
    &#125;

&#125;
</code></pre>
<h3 id="hystrix-feign服务降级类级别"><a class="markdownIt-Anchor" href="#hystrix-feign服务降级类级别"></a> Hystrix-Feign服务降级（类级别）</h3>
<p>前面所讲的HystrixCommon的fallbackMethod就是一种服务降级的方式，而这里我们要讲的是使用Feign对Hystrix的支持功能所实现的两一种服务降级的方式。</p>
<ul>
<li>在Feign接口所在包下定义降级处理类</li>
<li>在Feign接口中指定要使用的降级处理类</li>
<li>在配置文件中开启Feign对Hystrix的支持</li>
</ul>
<p><strong>Controller</strong></p>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.Controller;

<span class="keyword">import</span> com.lee.consumer.bean.Depart;
<span class="keyword">import</span> com.lee.consumer.service.DepartService;
<span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
<span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="keyword">import</span> java.util.List;

<span class="comment">/**</span>
<span class="comment"> * 使用openFeign后，不用再使用RestTemplate，编程风格和以前一样了</span>
<span class="comment"> */</span>
<span class="meta">@RestController</span>
<span class="meta">@RequestMapping(&quot;/consumer/depart&quot;)</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartController</span> &#123;

    <span class="meta">@Autowired</span>
    <span class="comment">//这里不再注入RestTemplate，注入service接口</span>
    <span class="keyword">private</span> DepartService service;

    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="keyword">return</span> service.saveDepart(depart);
    &#125;

    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="comment">//@PathVariable 表示获取url中的&#123;id&#125;的值</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteHandle</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> id)</span> &#123;
        <span class="keyword">return</span> service.removeDepartById(id);
    &#125;


    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updateHandle</span><span class="params">(Depart depart)</span> &#123;
        <span class="keyword">return</span> service.modifyDepart(depart);
    &#125;

    <span class="comment">//方法级别的服务降级</span>
    <span class="meta">@HystrixCommand(fallbackMethod = &quot;getHystrixHandle&quot;)</span>
    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    <span class="keyword">public</span> Depart <span class="title function_">GetHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span> <span class="keyword">throws</span> InterruptedException &#123;

        <span class="type">Depart</span> <span class="variable">depart</span> <span class="operator">=</span>  service.getDepartById(id);
        <span class="comment">//如果是服务端产生的异常则由类级别进行服务降级</span>
        <span class="comment">//在这个方法中抛出的异常由方法级别进行服务降级</span>
        <span class="comment">//模拟服务端调用延时，测试服务降级</span>
        Thread.sleep(<span class="number">5100</span>);
        <span class="keyword">return</span> depart;
    &#125;

    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listHandle</span><span class="params">()</span> &#123;
        <span class="keyword">return</span> service.listAllDeparts();
    &#125;

    <span class="comment">//当@HystrixCommand标注的方法不能正常访问时调用此方法</span>
    <span class="keyword">public</span> Depart <span class="title function_">getHystrixHandle</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span>&#123;
        <span class="type">Depart</span> <span class="variable">depart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Depart</span>();
        depart.setId(id);
        depart.setName(<span class="string">&quot;no this depart&quot;</span>);
        depart.setDbase(<span class="string">&quot;no this db&quot;</span>);
        System.out.println(<span class="string">&quot;方法降级++++&quot;</span>);
        <span class="keyword">return</span> depart;
    &#125;
&#125;</code></pre>
<p><strong>定义降级处理类</strong></p>
<ul>
<li>降级处理类需要实现FallbackFactory接口，该接口的泛型为Feign接口，该类可以定义在任意包下，不过，一般会与Feign接口定义在同一包下，本例在DepartService接口所在包中定义降级处理类DepartFallbackFactory</li>
<li>该类需要使用@Component注解，表示要将其交给Spring容器来管理</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.service;

<span class="keyword">import</span> com.lee.consumer.bean.Depart;
<span class="keyword">import</span> feign.hystrix.FallbackFactory;
<span class="keyword">import</span> org.springframework.stereotype.Component;

<span class="keyword">import</span> java.util.List;

<span class="comment">//服务降级处理类</span>
<span class="comment">//FallbackFactory&lt;&gt;的泛型是Feign的Service接口</span>
<span class="meta">@Component</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DepartFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;DepartService&gt; &#123;
    <span class="meta">@Override</span>
    <span class="keyword">public</span> DepartService <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;
        <span class="comment">//返回一个DeparteService()接口的对象</span>
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DepartService</span>() &#123;
            <span class="meta">@Override</span>
            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">saveDepart</span><span class="params">(Depart depart)</span> &#123;
                System.out.println(<span class="string">&quot;服务降级++++++saveDepart+++++++++&quot;</span>);
                <span class="keyword">return</span> <span class="literal">false</span>;
            &#125;

            <span class="meta">@Override</span>
            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">removeDepartById</span><span class="params">(<span class="type">int</span> id)</span> &#123;
                System.out.println(<span class="string">&quot;服务降级++++++removeDepartById+++++++++&quot;</span>);
                <span class="keyword">return</span> <span class="literal">false</span>;
            &#125;

            <span class="meta">@Override</span>
            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">modifyDepart</span><span class="params">(Depart depart)</span> &#123;
                System.out.println(<span class="string">&quot;服务降级++++++modifyDepart+++++++++&quot;</span>);
                <span class="keyword">return</span> <span class="literal">false</span>;
            &#125;

            <span class="meta">@Override</span>
            <span class="keyword">public</span> Depart <span class="title function_">getDepartById</span><span class="params">(<span class="type">int</span> id)</span> &#123;
                System.out.println(<span class="string">&quot;服务降级++++++getDepartById+++++++++&quot;</span>);
                <span class="type">Depart</span> <span class="variable">depart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Depart</span>();
                depart.setId(id);
                depart.setName(<span class="string">&quot;no this depart&quot;</span>);
                depart.setDbase(<span class="string">&quot;no this db&quot;</span>);
                <span class="keyword">return</span> depart;
            &#125;

            <span class="meta">@Override</span>
            <span class="keyword">public</span> List&lt;Depart&gt; <span class="title function_">listAllDeparts</span><span class="params">()</span> &#123;
                System.out.println(<span class="string">&quot;服务降级++++++listAllDeparts+++++++++&quot;</span>);
                <span class="keyword">return</span> <span class="literal">null</span>;
            &#125;
        &#125;;
    &#125;
&#125;
</code></pre>
<p><strong>在Feign接口指定服务降级类</strong></p>
<ul>
<li>@FeignClient的fallbackFactory属性指定服务降级类</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.consumer.service;

<span class="keyword">import</span> com.lee.consumer.bean.Depart;
<span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;
<span class="keyword">import</span> org.springframework.stereotype.Service;
<span class="keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="keyword">import</span> java.util.List;


<span class="comment">//指定当前service所绑定的提供者微服务的名称,指定服务降级处理类</span>
<span class="meta">@FeignClient(value=&quot;leemsc-provider-depart&quot;,fallbackFactory=DepartFallbackFactory.class)</span>
<span class="meta">@RequestMapping(&quot;/provider/depart&quot;)</span>
<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DepartService</span> &#123;
    <span class="meta">@PostMapping(&quot;/save&quot;)</span>
    <span class="type">boolean</span> <span class="title function_">saveDepart</span><span class="params">(Depart depart)</span>;
    <span class="meta">@DeleteMapping(&quot;/del/&#123;id&#125;&quot;)</span>
    <span class="type">boolean</span> <span class="title function_">removeDepartById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span>  <span class="type">int</span> id)</span>;
    <span class="meta">@PutMapping(&quot;/update&quot;)</span>
    <span class="type">boolean</span> <span class="title function_">modifyDepart</span><span class="params">(Depart depart)</span>;
    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span>
    Depart <span class="title function_">getDepartById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span>;
    <span class="meta">@GetMapping(&quot;/list&quot;)</span>
    List&lt;Depart&gt; <span class="title function_">listAllDeparts</span><span class="params">()</span>;
&#125;
</code></pre>
<p><strong>修改主配置文件</strong></p>
<pre><code class="highlight properties"><span class="comment">#指定端口号</span>
<span class="attr">server.port</span>=<span class="string">8080</span>
<span class="comment"></span>
<span class="comment">#指定微服务对外暴露的名称</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-consumer-depart</span>
<span class="comment"></span>
<span class="comment">#指定Eureka服务注册中心</span>
<span class="attr">eureka.client.service-url.defaultZone</span>=<span class="string">http://localhost:8000/eureka</span>
<span class="comment"></span>
<span class="comment">#开启Feign对Hystrix的支持</span>
<span class="attr">feign.hystrix.enabled</span>=<span class="string">true</span>
<span class="comment">#设置服务熔断时限，默认为5000毫秒（即等待响应的时间）</span>
<span class="attr">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</span>=<span class="string">5000</span></code></pre>
<p><strong>运行：</strong></p>
<p>由于改代码中同时出现了两种降级方式</p>
<ul>
<li>所以运行时如果只是服务端出现了问题，那么返回的是fallbackFactory的响应结果，fallbackMethod则未执行</li>
<li>如果运行时服务端调用没问题，消费者处理器执行过程中有异常，则fallbackFactory不执行，fallbackMethod执行</li>
<li>如果运行时服务端出现了问题，消费者处理器执行过程中也有异常，则两个都执行</li>
</ul>
<h3 id="两种降级同时使用"><a class="markdownIt-Anchor" href="#两种降级同时使用"></a> 两种降级同时使用</h3>
<p>一般情况下这两种方式同时使用，fallbackMethod方式用于解决处理器执行过程中的异常问题，而服务降级类方式用于解决未获取到服务问题</p>
<h2 id="网关服务zuul"><a class="markdownIt-Anchor" href="#网关服务zuul"></a> 网关服务zuul</h2>
<p>zuul时从设备和web站点到Netflix流应用后端的所有请求的前门，作为边界服务应用，zuul实现类动态路由，监视，弹性和安全性而构建的，它还具有根据情况将请求路由到多个Amazon Auto Scaling Groups的能力</p>
<h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3>
<p>Zuul主要提供了对请求的路由与过滤功能。路由功能主要指，将外部请求转发到具体的微服务实例上，是外部访问微服务的统一入口。 过滤功能主要指，对请求的处理过程进行干预，对请求进行校验、服务聚合等处理。</p>
<p>Zuul与Eureka进行整合,将Zuul自身注册为Eureka服务治理下的应用，从Eureka Server中获取到其它微服务信息，使外部对于微服务的访问都是通过Zuul进行转发的。</p>
<p>那么，具体怎么使用呢?服务提供者是消费者通过EurekaServer进行访问的，即相当于EurekaSenver是服务提供者的统一入口。那么服务消费者很多，用户怎样访问这些消费者工程呢?当然可以像之前那样直接访问这些工程。但这种方式没有统一的消费者工程调用入口，不便于访问与管理，而Zuul就是这样的一个对于消费者的统一入口。这点，从Spring官网<a target="_blank" rel="noopener" href="http://spring.xn--io-uv2c6e61b4sr2mpsekzi208b75a679g0xhu73j">http://spring.io最下面的图中可以体现出来</a>。</p>
<h3 id="基本用法"><a class="markdownIt-Anchor" href="#基本用法"></a> 基本用法</h3>
<p><strong>创建一个springboot工程</strong><br />
创建一个Spring boot工程</p>
<p>项目名称：</p>
<p>添加依赖：</p>
<p><strong>pom依赖</strong></p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zuulserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>zuulserver<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>

    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>主配置文件</strong></p>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">9000</span>
<span class="comment">#设置服务注册中心</span>
<span class="attr">eureka.client.service-url.defaultZone</span>:<span class="string">http://localhost:8000/eureka</span>
<span class="comment"></span>
<span class="comment">#设置spring应用名</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-zuul-depart</span></code></pre>
<p><strong>启动类</strong></p>
<ul>
<li>启动类使用@EnableZuulProxy开启zuul代理模式</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.zuulserver;

<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.netflix.zuul.EnableZuulProxy;

<span class="comment">//开启zuul代理模式</span>
<span class="meta">@EnableZuulProxy</span>
<span class="meta">@SpringBootApplication</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZuulserverApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ZuulserverApplication.class, args);
    &#125;

&#125;</code></pre>
<p><strong>访问测试</strong></p>
<ul>
<li>通过zuul来访问consumer</li>
</ul>
<pre><code class="highlight plaintext">http://localhost:9000/leemsc-consumer-depart/consumer/depart/get/2</code></pre>
<h3 id="路由访问映射规则"><a class="markdownIt-Anchor" href="#路由访问映射规则"></a> 路由访问映射规则</h3>
<p><strong>修改主配置文件</strong></p>
<ul>
<li>leedepart可以随意命名，但service-id与path是关键字，不能更改</li>
<li>leedepart.service-id指定要被替换掉的微服务名称</li>
<li>leedepart.path指定用于替换指定微服务名称的路径</li>
</ul>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">9000</span>
<span class="comment">#设置服务注册中心</span>
<span class="attr">eureka.client.service-url.defaultZone</span>:<span class="string">http://localhost:8000/eureka</span>
<span class="comment"></span>
<span class="comment">#设置spring应用名</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-zuul-depart</span>
<span class="comment"></span>
<span class="comment">#设置zuul路由规则</span>
<span class="comment">#设置要被替换的微服务名称</span>
<span class="attr">zuul.routes.leedepart.service-id</span>=<span class="string">leemsc-consumer-depart</span>
<span class="comment">#指定替换使用的路径</span>
<span class="attr">zuul.routes.leedepart.path</span>=<span class="string">/condep/**</span></code></pre>
<p><strong>测试</strong></p>
<ul>
<li>访问路径修改成了替换的名字，可以隐藏真正的consumer名</li>
</ul>
<h3 id="忽略服务名称"><a class="markdownIt-Anchor" href="#忽略服务名称"></a> 忽略服务名称</h3>
<p>以上配置虽然可以使用映射路径访问微服务，但通过原来的服务名称仍然可以访问到微服务，即以上的配置并没有隐藏和保护原来的微服务名称，可以在配置文件中设置忽略微服务属性，禁掉原来所有的微服务名称使用，有两种设置方式，忽略指定微服务，与忽略所有微服务</p>
<p><strong>忽略指定微服务名称</strong></p>
<ul>
<li>在配置文件中指定要忽略的微服务</li>
</ul>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">9000</span>
<span class="comment">#设置服务注册中心</span>
<span class="attr">eureka.client.service-url.defaultZone</span>:<span class="string">http://localhost:8000/eureka</span>
<span class="comment"></span>
<span class="comment">#设置spring应用名</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-zuul-depart</span>
<span class="comment"></span>
<span class="comment">#设置zuul路由规则</span>
<span class="comment">#设置要被替换的微服务名称</span>
<span class="attr">zuul.routes.leedepart.service-id</span>=<span class="string">leemsc-consumer-depart</span>
<span class="comment">#指定替换使用的路径</span>
<span class="attr">zuul.routes.leedepart.path</span>=<span class="string">/condep/**</span>
<span class="comment"></span>
<span class="comment">#指定要忽略的微服务(即通过此名称无法访问，只可以使用替换的路径)</span>
<span class="attr">zuul.ignored-services</span>=<span class="string">leemsc-consumer-depart</span></code></pre>
<blockquote>
<p>此时再通过微服务名称已经无法访问到微服务了，但通过映射路径是可以访问到的</p>
</blockquote>
<p><strong>忽略所有微服务名称</strong></p>
<ul>
<li>指定所有的微服务名称都无法访问，只能通过替换的名称</li>
</ul>
<pre><code class="highlight properties"><span class="comment">#指定所有的微服务名称都无法访问，只能通过替换的名称</span>
<span class="attr">zuul.ignored-services</span>=<span class="string">*</span></code></pre>
<p><strong>测试访问</strong><br />
通过别名可以访问：</p>
<p>通过微服务全称无法访问：</p>
<h3 id="为映射路径配置统一前缀"><a class="markdownIt-Anchor" href="#为映射路径配置统一前缀"></a> 为映射路径配置统一前缀</h3>
<p>一般情况下我们会在映射路径前添加一个前缀用于表示模块信息或公司名称等，而前缀对于各个微服务来说一般都是需要的，我们可以为映射路径统一配置前缀</p>
<p><strong>修改主配置文件</strong></p>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">9000</span>
<span class="comment">#设置服务注册中心</span>
<span class="attr">eureka.client.service-url.defaultZone</span>:<span class="string">http://localhost:8000/eureka</span>
<span class="comment"></span>
<span class="comment">#设置spring应用名</span>
<span class="attr">spring.application.name</span>=<span class="string">leemsc-zuul-depart</span>
<span class="comment"></span>
<span class="comment">#设置zuul路由规则</span>
<span class="comment">#设置要被替换的微服务名称</span>
<span class="attr">zuul.routes.leedepart.service-id</span>=<span class="string">leemsc-consumer-depart</span>
<span class="comment">#指定替换使用的路径</span>
<span class="attr">zuul.routes.leedepart.path</span>=<span class="string">/condep/**</span>
<span class="comment"></span>
<span class="comment">#指定要忽略的微服务(即通过此名称无法访问，只可以使用替换的路径)</span>
<span class="comment">#zuul.ignored-services=leemsc-consumer-depart</span>
<span class="comment"></span>
<span class="comment">#指定所有的微服务名称都无法访问，只能通过替换的名称</span>
<span class="attr">zuul.ignored-services</span>=<span class="string">*</span>
<span class="comment"></span>
<span class="comment">#指定访问的统一前缀</span>
<span class="attr">zuul.prefix</span>=<span class="string">/depart</span></code></pre>
<p><strong>测试访问</strong></p>
<h2 id="spring-cloud-config分布式配置中心"><a class="markdownIt-Anchor" href="#spring-cloud-config分布式配置中心"></a> Spring Cloud Config分布式配置中心</h2>
<p>SpringCloudConfig的原理是,我们首先需要将各个微服务公共的配置信息推送到GitHub远程版本库。然后我们再定义一个Spring Cloud Config Server,其会连接上这个GitHub远程库。这样我们就可以定义Config版的Eureka Server、 提供者与消费者了。这些都将作为SpringCloudConfig Client出现，它们都会通过连接Spring Cloud Config server连接上GitHub上的远程库，以读取到指定配置文件中的内容。</p>
<h3 id="github远程库设置"><a class="markdownIt-Anchor" href="#github远程库设置"></a> github远程库设置</h3>
<h4 id="前提准备"><a class="markdownIt-Anchor" href="#前提准备"></a> 前提准备</h4>
<p><strong>非对称加密原理</strong></p>
<p><strong>设置github免密登录</strong><br />
使用gitBash输入命令生成私/公钥</p>
<pre><code class="highlight plaintext">ssh-keygen</code></pre>
<p>然后再<code>C:\Users\leeboer\.ssh</code>文件夹找到公钥，打开，复制里面的内容放到github上</p>
<p><strong>建立远程库</strong></p>
<p><strong>clone远程库到本地</strong></p>
<pre><code class="highlight plaintext">git clone https://github.com/leeboer/SpringConfigTest.git</code></pre>
<h4 id="创建本地配置文件并推送到远程库"><a class="markdownIt-Anchor" href="#创建本地配置文件并推送到远程库"></a> 创建本地配置文件并推送到远程库</h4>
<blockquote>
<p><strong>spring cloud config工程必须使用yml文件，使用其他配置文件在git无法读取</strong></p>
</blockquote>
<p><strong>创建本地配置文件</strong></p>
<p>我们需要定义并推送三个配置文件，这三个配置文件分别是为了后续EurekaServer，provider，与consumer使用的</p>
<p>多环境测试文件：application.yml</p>
<ul>
<li>yml多配置之间要使用 “—” 分割</li>
</ul>
<pre><code class="highlight yml"><span class="attr">spring:</span>
  <span class="attr">profiles:</span>
    <span class="attr">active:</span> <span class="string">dev</span>

<span class="meta">---</span>
<span class="comment">#dev配置</span>
<span class="attr">spring:</span>
  <span class="attr">application:</span>
    <span class="attr">name:</span> <span class="string">leemsc-config-dev</span>
  <span class="attr">profiles:</span>
    <span class="attr">active:</span> <span class="string">dev</span>

<span class="meta">---</span>
<span class="comment">#test配置</span>
<span class="attr">spring:</span>
  <span class="attr">application:</span>
    <span class="attr">name:</span> <span class="string">leemsc-config-test</span>
  <span class="attr">profiles:</span>
    <span class="attr">active:</span> <span class="string">test</span></code></pre>
<p>application-consumer-config.properties</p>
<pre><code class="highlight properties"><span class="comment">#配置dev环境</span>
<span class="attr">server</span>:<span class="string"></span>
  <span class="attr">port</span>: <span class="string">7070</span>
<span class="attr">spring</span>:<span class="string"></span>
  <span class="attr">application</span>:<span class="string"></span>
    <span class="attr">name</span>: <span class="string">leemsc-consumer-depart</span>
  <span class="attr">profiles</span>: <span class="string">dev</span>

<span class="attr">eureka</span>:<span class="string"></span>
  <span class="attr">client</span>:<span class="string"></span>
    <span class="attr">service-url</span>:<span class="string"></span>
      <span class="attr">defaultZone</span>: <span class="string">http://localhost:8100/eureka</span>
<span class="attr">feign</span>:<span class="string"></span>
  <span class="attr">hystrix</span>:<span class="string"></span>
    <span class="attr">enabled</span>: <span class="string">true</span>
<span class="attr">hystrix</span>:<span class="string"></span>
  <span class="attr">command</span>:<span class="string"></span>
    <span class="attr">default</span>:<span class="string"></span>
      <span class="attr">execution</span>:<span class="string"></span>
        <span class="attr">isolation</span>:<span class="string"></span>
          <span class="attr">thread</span>:<span class="string"></span>
            <span class="attr">timeoutInMilliseconds</span>: <span class="string">5000</span>



<span class="attr">---</span>
<span class="comment">#配置test环境</span>
<span class="attr">server</span>:<span class="string"></span>
  <span class="attr">port</span>: <span class="string">9090</span>
<span class="attr">spring</span>:<span class="string"></span>
  <span class="attr">application</span>:<span class="string"></span>
    <span class="attr">name</span>: <span class="string">leemsc-consumer-depart</span>
  <span class="attr">profiles</span>: <span class="string">test</span>

<span class="attr">eureka</span>:<span class="string"></span>
  <span class="attr">client</span>:<span class="string"></span>
    <span class="attr">service-url</span>:<span class="string"></span>
      <span class="attr">defaultZone</span>: <span class="string">http://localhost:8200/eureka</span>
<span class="attr">feign</span>:<span class="string"></span>
  <span class="attr">hystrix</span>:<span class="string"></span>
    <span class="attr">enabled</span>: <span class="string">true</span>
<span class="attr">hystrix</span>:<span class="string"></span>
  <span class="attr">command</span>:<span class="string"></span>
    <span class="attr">default</span>:<span class="string"></span>
      <span class="attr">execution</span>:<span class="string"></span>
        <span class="attr">isolation</span>:<span class="string"></span>
          <span class="attr">thread</span>:<span class="string"></span>
            <span class="attr">timeoutInMilliseconds</span>: <span class="string">5000</span></code></pre>
<p>application-provider-config.properties</p>
<pre><code class="highlight properties"><span class="comment">#dev环境</span>
<span class="attr">server</span>:<span class="string"></span>
  <span class="attr">port</span>: <span class="string">8082</span>

<span class="attr">spring</span>:<span class="string"></span>
  <span class="attr">profiles</span>: <span class="string">dev</span>
  <span class="attr">application</span>:<span class="string"></span>
    <span class="attr">name</span>: <span class="string">leemsc-provider-depart</span>
  <span class="attr">datasource</span>:<span class="string"></span>
    <span class="attr">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span>
    <span class="attr">password</span>: <span class="string">123456</span>
    <span class="attr">type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span>
    <span class="attr">url</span>: <span class="string">jdbc:mysql://127.0.0.1:3306/leetest01?characterEncoding=UTF-8</span>
    <span class="attr">username</span>: <span class="string">root</span>
  <span class="attr">jpa</span>:<span class="string"></span>
    <span class="attr">generate-ddl</span>: <span class="string">true</span>
    <span class="attr">hibernate</span>:<span class="string"></span>
      <span class="attr">ddl-auto</span>: <span class="string">none</span>
    <span class="attr">show-sql</span>: <span class="string">true</span>

<span class="attr">eureka</span>:<span class="string"></span>
  <span class="attr">client</span>:<span class="string"></span>
    <span class="attr">service-url</span>:<span class="string"></span>
      <span class="attr">defaultZone</span>: <span class="string">http://localhost:8100/eureka</span>

<span class="attr">logging</span>:<span class="string"></span>
  <span class="attr">level</span>:<span class="string"></span>
    <span class="attr">com</span>:<span class="string"></span>
      <span class="attr">lee</span>: <span class="string">debug</span>
    <span class="attr">org</span>:<span class="string"></span>
      <span class="attr">hibernate</span>: <span class="string">info</span>
      <span class="attr">hibernate.type.descriptor.sql.BasicBinder</span>: <span class="string">trace</span>
    <span class="attr">root</span>: <span class="string">info</span>
  <span class="attr">pattern</span>:<span class="string"></span>
    <span class="attr">console</span>: <span class="string">&#x27;%level %msg%n&#x27;</span>
<span class="attr">info</span>:<span class="string"></span>
  <span class="attr">app</span>:<span class="string"></span>
    <span class="attr">name</span>: <span class="string">leemsc-provider-depart</span>
    <span class="attr">people</span>: <span class="string">leeboer</span>
  <span class="attr">company</span>:<span class="string"></span>
    <span class="attr">address</span>: <span class="string">xian</span>
    <span class="attr">name</span>: <span class="string">leeboer.xyz</span>
    <span class="attr">tel</span>: <span class="string">123456798</span>



<span class="attr">---</span>
<span class="comment">#test环境</span>
<span class="attr">server</span>:<span class="string"></span>
  <span class="attr">port</span>: <span class="string">8083</span>

<span class="attr">spring</span>:<span class="string"></span>
  <span class="attr">profiles</span>: <span class="string">test</span>
  <span class="attr">application</span>:<span class="string"></span>
    <span class="attr">name</span>: <span class="string">leemsc-provider-depart</span>
  <span class="attr">datasource</span>:<span class="string"></span>
    <span class="attr">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span>
    <span class="attr">password</span>: <span class="string">123456</span>
    <span class="attr">type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span>
    <span class="attr">url</span>: <span class="string">jdbc:mysql://127.0.0.1:3306/leetest?characterEncoding=UTF-8</span>
    <span class="attr">username</span>: <span class="string">root</span>
  <span class="attr">jpa</span>:<span class="string"></span>
    <span class="attr">generate-ddl</span>: <span class="string">true</span>
    <span class="attr">hibernate</span>:<span class="string"></span>
      <span class="attr">ddl-auto</span>: <span class="string">none</span>
    <span class="attr">show-sql</span>: <span class="string">true</span>

<span class="attr">eureka</span>:<span class="string"></span>
  <span class="attr">client</span>:<span class="string"></span>
    <span class="attr">service-url</span>:<span class="string"></span>
      <span class="attr">defaultZone</span>: <span class="string">http://localhost:8200/eureka</span>

<span class="attr">logging</span>:<span class="string"></span>
  <span class="attr">level</span>:<span class="string"></span>
    <span class="attr">com</span>:<span class="string"></span>
      <span class="attr">lee</span>: <span class="string">debug</span>
    <span class="attr">org</span>:<span class="string"></span>
      <span class="attr">hibernate</span>: <span class="string">info</span>
      <span class="attr">hibernate.type.descriptor.sql.BasicBinder</span>: <span class="string">trace</span>
    <span class="attr">root</span>: <span class="string">info</span>
  <span class="attr">pattern</span>:<span class="string"></span>
    <span class="attr">console</span>: <span class="string">&#x27;%level %msg%n&#x27;</span>
<span class="attr">info</span>:<span class="string"></span>
  <span class="attr">app</span>:<span class="string"></span>
    <span class="attr">name</span>: <span class="string">leemsc-provider-depart</span>
    <span class="attr">people</span>: <span class="string">leeboer</span>
  <span class="attr">company</span>:<span class="string"></span>
    <span class="attr">address</span>: <span class="string">xian</span>
    <span class="attr">name</span>: <span class="string">leeboer.xyz</span>
    <span class="attr">tel</span>: <span class="string">123456798</span>
</code></pre>
<p>application-eureka-config.properties</p>
<pre><code class="highlight yml"><span class="comment">#dev环境</span>
<span class="attr">spring:</span>
  <span class="attr">application:</span>
    <span class="attr">name:</span> <span class="string">leemsc-eurekaServer-config</span>
  <span class="attr">profiles:</span> <span class="string">dev</span>
<span class="attr">server:</span>
  <span class="attr">port:</span> <span class="number">8100</span>
<span class="attr">eureka:</span>
  <span class="attr">instance:</span>
    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#指定Eureka主机</span>
  <span class="attr">client:</span>
    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#指定当前主机是否需要获取注册信息</span>
    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#指定当前主机是否需要向注册中心注册</span>
    <span class="attr">service-url:</span>
      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8100/eureka</span> <span class="comment">#暴露服务中心地址</span>


<span class="meta">---</span>
<span class="comment">#test测试环境</span>
<span class="attr">spring:</span>
  <span class="attr">application:</span>
    <span class="attr">name:</span> <span class="string">leemsc-eurekaServer-config</span>
  <span class="attr">profiles:</span> <span class="string">test</span>
<span class="attr">server:</span>
  <span class="attr">port:</span> <span class="number">8200</span>
<span class="attr">eureka:</span>
  <span class="attr">instance:</span>
    <span class="attr">hostname:</span> <span class="string">localhost</span>
  <span class="attr">client:</span>
    <span class="attr">fetch-registry:</span> <span class="literal">false</span>
    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>
    <span class="attr">service-url:</span>
      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8200/eureka</span>
</code></pre>
<p><strong>把本地配置文件推送到远程库</strong></p>
<pre><code class="highlight plaintext">$ git add *

$ git commit -m &quot;first one&quot;

$ git push</code></pre>
<h3 id="创建spring-cloud-config工程"><a class="markdownIt-Anchor" href="#创建spring-cloud-config工程"></a> 创建Spring Cloud Config工程</h3>
<p>该工程将存放当前项目中所有EurekaServer的配置文件，服务提供者，服务消费者等工程的配置文件公共服务</p>
<h4 id="环境搭建"><a class="markdownIt-Anchor" href="#环境搭建"></a> 环境搭建</h4>
<p><strong>创建spring boot工程</strong></p>
<p>定义一个基础的spring boot工程：</p>
<p>项目名：</p>
<p>添加config server依赖：</p>
<p><strong>pom依赖</strong></p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>configserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>configserver<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>

    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>定义配置文件</strong></p>
<ul>
<li>指定当前工程所关联的git远程库地址</li>
</ul>
<pre><code class="highlight properties"><span class="attr">server.port</span>=<span class="string">9999</span>
<span class="comment"></span>
<span class="comment">#指定当前工程所关联的git远程库地址</span>
<span class="attr">spring.cloud.config.server.git.uri</span>=<span class="string">git@github.com:leeboer/SpringConfigTest.git</span>
</code></pre>
<p><strong>定义启动类</strong></p>
<ul>
<li>加上@EnableConfigServer注解</li>
</ul>
<pre><code class="highlight java"><span class="keyword">package</span> com.lee.configserver;

<span class="keyword">import</span> org.springframework.boot.SpringApplication;
<span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="keyword">import</span> org.springframework.cloud.config.server.EnableConfigServer;

<span class="comment">//开启ConfigServer服务</span>
<span class="meta">@EnableConfigServer</span>
<span class="meta">@SpringBootApplication</span>
<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigserverApplication</span> &#123;

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;
        SpringApplication.run(ConfigserverApplication.class, args);
    &#125;

&#125;
</code></pre>
<h4 id="运行访问"><a class="markdownIt-Anchor" href="#运行访问"></a> 运行访问</h4>
<p>此时，Config Server服务器就已经定义完毕了，为了证明通过该服务器可以成功访问到Github的远程库的文件，现以之前上传到远程库中的多环境选择配置文件为例，查看多环境的切换</p>
<p><strong>1 完成多环境切换</strong></p>
<p>注意，下面的操作是通过读取远程库中的application.properties文件，并完成多环境的切换，并非简单的读取远程库文件</p>
<ul>
<li>A-切换到dev环境</li>
</ul>
<p>地址栏中输入的是可以完成多环境选择的application-dev.properties，并非是上传到远程库的application.properties，并会切换至配置文件中存在的dev环境，页面显示的dev环境信息及工共配置信息，并未显示test环境信息</p>
<ul>
<li>B-切换到test环境</li>
</ul>
<p>切换至配置文件的test环境，页面显示的是test的环境信息和工共配置信息，但并未显示dev的环境信息</p>
<ul>
<li>C-切换到不同存在的环境</li>
</ul>
<p>切换到不存在的环境，则页面显示公共配置信息，其他多环境信息不显示。</p>
<p><strong>2 切换到指定分支的指定环境</strong></p>
<p>切换到master分支的dev环境，默认即为master分支，即前面的切换都是切换到了默认master分支的多环境</p>
<p><strong>3 读取master分支上有关dev的配置信息</strong></p>
<h3 id="定义config版的eureka-server服务器"><a class="markdownIt-Anchor" href="#定义config版的eureka-server服务器"></a> 定义config版的Eureka Server服务器</h3>
<p>只需要三步：</p>
<ul>
<li>添加spring-cloud-starter-config依赖</li>
<li>删除旧的application.properties</li>
<li>添加bootstrap.yml文件</li>
</ul>
<p><strong>pom依赖</strong></p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>
<span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>
    <span class="tag">&lt;<span class="name">parent</span>&gt;</span>
        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eurekaserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
    <span class="tag">&lt;<span class="name">name</span>&gt;</span>eurekaserver<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span>

    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>
        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>
        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
        <span class="comment">&lt;!--添加spring cloud config客户端依赖--&gt;</span>
        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>

        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>

    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>
        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>
            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span>
                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span>

    <span class="tag">&lt;<span class="name">build</span>&gt;</span>
        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>
            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>
                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>

<span class="tag">&lt;/<span class="name">project</span>&gt;</span>
</code></pre>
<p><strong>定义bootstrap.yml</strong></p>
<p>下面的配置必须定义在bootstrap.yml文件中，若定义在application中，则Eureka无法启动（因为我们的配置文件是远程加载的，所以删掉原来的application）</p>
<p>bootstrapyml文件是在应用程序启动时加载的，而其中的配置一般也都是应用程序启动时所必须的数据。application.xml中配置 数据则是应用程序启动后在执行过程中要读取的数据。例如，本例的Eureka若要启动，则必须要在启动过程中读取到指定的GitHub中配置文件的数据，否则无法启动。所以，这些信息需要配置在bootstrap.yml中，若配置在applicationyml中，应用在启动时是读取不到的。</p>
<pre><code class="highlight yml"><span class="attr">spring:</span>
  <span class="attr">cloud:</span>
    <span class="attr">config:</span>
      <span class="comment">#指定configServer的地址</span>
      <span class="attr">uri:</span> <span class="string">http://localhost:9999</span>
      <span class="comment">#指定要访问远程库的分支</span>
      <span class="attr">label:</span> <span class="string">master</span>
      <span class="comment">#指定要从远程库读取的配置文件名（无需加yml扩展名，因为只能使用yml文件）</span>
      <span class="attr">name:</span> <span class="string">application-eureka-config</span>
      <span class="comment">#选择环境</span>
      <span class="attr">profile:</span> <span class="string">dev</span></code></pre>
<blockquote>
<p>由于当前主机要运行的真正自己需要的配置文件信息需要从远程库中读取，所以这里的application.yml文件就不再需要了，将其<strong>删除</strong></p>
</blockquote>
<p><strong>启动</strong></p>
<p>若配置文件修改了，则需要将修改的配置文件提交到远程库，然后还需要重启config server工程</p>
<p><strong>运行</strong></p>
<p>如果不指定读取的环境，则<u>默认读取的是dev</u></p>
<p>运行成功</p>
<blockquote>
<p>默认是dev，那么如何切换到test呢？其并不能像普通的spring boot工程那样，在运行jar文件时通过添加参数进行切换，因为环境配置信息均是从远程仓库拉取的，本地是没有要切换的环境信息的，而要获取这些信息，只能通过修改配置文件中的环境选择属性，然后将修改推送到远程库，重启Config Server，这样才能切换环境</p>
</blockquote>
<h3 id="定义config版的provider服务器"><a class="markdownIt-Anchor" href="#定义config版的provider服务器"></a> 定义config版的provider服务器</h3>
<p>只需要三步：</p>
<ul>
<li>添加spring-cloud-starter-config依赖</li>
</ul>
<pre><code class="highlight xml"><span class="comment">&lt;!--添加spring cloud config客户端依赖--&gt;</span>
       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></code></pre>
<ul>
<li>删除旧的application.properties</li>
<li>添加bootstrap.yml文件</li>
</ul>
<pre><code class="highlight yml"><span class="attr">spring:</span>
  <span class="attr">cloud:</span>
    <span class="attr">config:</span>
      <span class="comment">#指定configServer的地址</span>
      <span class="attr">uri:</span> <span class="string">http://localhost:9999</span>
      <span class="comment">#指定要访问远程库的分支</span>
      <span class="attr">label:</span> <span class="string">master</span>
      <span class="comment">#指定要从远程库读取的配置文件名（无需加yml扩展名，因为只能使用yml文件）</span>
      <span class="attr">name:</span> <span class="string">application-provider-config</span>
      <span class="comment">#选择环境</span>
      <span class="attr">profile:</span> <span class="string">dev</span></code></pre>
<h3 id="定义config版的consumer服务器"><a class="markdownIt-Anchor" href="#定义config版的consumer服务器"></a> 定义config版的consumer服务器</h3>
<p>只需要三步：</p>
<ul>
<li>添加spring-cloud-starter-config依赖</li>
</ul>
<pre><code class="highlight xml"><span class="comment">&lt;!--添加spring cloud config客户端依赖--&gt;</span>
       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></code></pre>
<ul>
<li>删除旧的application.properties</li>
<li>添加bootstrap.yml文件</li>
</ul>
<pre><code class="highlight yml"><span class="attr">spring:</span>
  <span class="attr">cloud:</span>
    <span class="attr">config:</span>
      <span class="comment">#指定configServer的地址</span>
      <span class="attr">uri:</span> <span class="string">http://localhost:9999</span>
      <span class="comment">#指定要访问远程库的分支</span>
      <span class="attr">label:</span> <span class="string">master</span>
      <span class="comment">#指定要从远程库读取的配置文件名（无需加yml扩展名，因为只能使用yml文件）</span>
      <span class="attr">name:</span> <span class="string">application-consumer-config</span>
      <span class="comment">#选择环境</span>
      <span class="attr">profile:</span> <span class="string">dev</span></code></pre></main>

</article>


<script src="/js/highlight.js"></script>

  </main>
  <footer class="footer">
  
  <span>Copyright © 2026 Lism Blog | lisisism@qq.com</span>
  
</footer>
  
<script src="/js/theme.js"></script>

</body>

</html>